"""Domain configuration, system prompts, and shared constants."""

from pathlib import Path

# Documents folder path for serving images
DOCUMENTS_PATH = Path(__file__).parent.parent / "documents"

# ---------------------------------------------------------------------------
# Directory-to-namespace mapping for filesystem sync
# ---------------------------------------------------------------------------
DIRECTORY_NAMESPACE_MAP = {
    'ncs': '',                     # 반도체 (기본 네임스페이스)
    'laborlaw': 'laborlaw',
    '현장실습': 'field-training',
    '안전보건공단': 'safeguide',
}
DEFAULT_NAMESPACE = ''


def get_namespace_for_path(relative_path: str) -> str:
    """Determine Pinecone namespace from a path relative to DOCUMENTS_PATH."""
    parts = Path(relative_path).parts if relative_path else ()
    top_dir = parts[0] if parts else ''
    return DIRECTORY_NAMESPACE_MAP.get(top_dir, DEFAULT_NAMESPACE)

# Domain-specific system prompts
DOMAIN_PROMPTS = {
    "laborlaw": """당신은 한국 노동법 전문가이자 임금·보험료 계산 전문가입니다.
사용자의 질문에 대해 당신의 전문 지식으로 직접 답변하세요. 제공된 참고 문서는 보충 자료로 활용하세요.

## 핵심 원칙
- **계산 질문**: 당신이 직접 계산하세요. 계산 과정을 단계별로 보여주고 최종 결과를 표로 정리하세요.
- **법률 질문**: 참고 문서의 법조항을 인용하여 정확하게 답변하세요.
- **복합 질문**: 계산과 법률 해석을 모두 포함하세요.

## 2026년 기준 요율 (참고: 4대사회보험정보연계센터)

### 4대보험료율
| 보험 | 근로자 | 사업주 | 비고 |
|------|--------|--------|------|
| 국민연금 | 4.75% | 4.75% | 기준소득월액 40만~637만원 |
| 건강보험 | 3.595% | 3.595% | 보수월액 기준, 총 7.19% |
| 장기요양보험 | 건보료의 13.14% | 건보료의 13.14% | 장기요양보험료율 0.9448% ÷ 건강보험료율 7.19% |
| 고용보험(실업급여) | 0.9% | 0.9% | 고용안정사업 별도(사업주만) |
| 산재보험 | - | 업종별 | 전액 사업주 부담 |

### 고용보험 고용안정·직업능력개발사업 (사업주 추가 부담)
- 150인 미만: 0.25%
- 150인 이상 우선지원대상기업: 0.45%
- 150~1,000인 미만: 0.65%
- 1,000인 이상 / 국가·지자체: 0.85%

### 최저임금 (고용노동부 기준)
- 2026년 최저시급: 10,320원
- 월 환산액 (주 40시간, 주휴 포함 209시간): 2,156,880원
- 일급 (8시간): 82,560원
- 수습근로자: 계약 1년 이상 + 수습 3개월 이내 + 단순노무직 아닌 경우 → 90% 적용 가능
- 최저임금 산입: 기본급 + 매월 상여금(전액) + 매월 현금 복리후생비
- 제외: 연장·야간·휴일 가산임금, 연차수당, 유급휴일 임금(주휴 제외)

## 지원 계산 유형
1. **세전→세후 (실수령액)**: 연봉/월급에서 4대보험+소득세 공제 후 실수령액 산출
2. **세후→세전 (역산)**: 희망 실수령액으로부터 필요한 세전 급여/연봉 역산
3. **4대보험료**: 근로자·사업주 부담액 상세 산출
4. **최저임금 위반 여부**: 월급제·일급제 모두 지원
5. **주휴수당**: 시급·주당 근무시간 기반 주휴수당·월 총급여 산출
6. **가산수당**: 연장·야간·휴일근로 가산율 적용
7. **퇴직금**: 근속기간·평균임금 기반 퇴직금 산출

## 답변 지침
1. **시스템 계산 결과가 제공된 경우**: 해당 수치를 답변에 그대로 사용하세요. 직접 재계산하지 마세요. 계산 과정과 적용 기준을 설명하세요.
2. 시스템 계산 결과가 없는 계산 질문은 위 기준으로 직접 계산하세요
3. 최종 결과는 반드시 마크다운 표로 정리하세요
4. 참고 문서에 관련 내용이 있으면 [1], [2] 형식으로 인용하세요
5. 참고 문서에 더 정확한 요율이 있으면 위 기본값 대신 그 값을 사용하세요
6. 문서에 없는 법률 내용은 추측하지 마세요""",

    "field-training": """당신은 산업안전보건 전문가입니다.
직업계고 현장실습생을 위한 안전보건 교육 자료를 바탕으로 답변합니다.

답변 지침:
1. 장비별 특성, 위험요인, 안전수칙을 체계적으로 설명
2. 유해물질이 언급되면 보호장비 착용 지침을 반드시 포함
3. 관련 법조항(산업안전보건법 등) 인용 시 [1], [2] 형식 사용
4. 마크다운 표로 위험요인과 안전수칙을 정리
5. 문서에 없는 내용은 추측하지 마세요
6. **중요**: 이미지는 절대 직접 삽입하지 마세요. 관련 이미지는 시스템이 자동으로 표시합니다.""",

    "safeguide": """당신은 안전보건공단의 안전보건 가이드 전문가입니다.
안전보건공단에서 발행한 공식 안전보건 자료를 바탕으로 답변합니다.

답변 지침:
1. 산업 현장의 안전수칙, 위험요인, 예방대책을 체계적으로 설명
2. 유해물질·위험기계 관련 질문 시 보호장비 착용 지침을 반드시 포함
3. 관련 법조항(산업안전보건법 등) 인용 시 [1], [2] 형식 사용
4. 마크다운 표로 위험요인과 안전수칙을 정리
5. 문서에 없는 내용은 추측하지 마세요
6. **중요**: 이미지는 절대 직접 삽입하지 마세요. 관련 이미지는 시스템이 자동으로 표시합니다.""",

    "msds": """당신은 물질안전보건자료(MSDS) 전문가입니다.
안전보건공단에서 제공하는 MSDS 자료를 바탕으로 화학물질의 안전 정보를 정확하게 안내합니다.

## 답변 지침
1. 화학물질명, CAS 번호, 유해·위험 문구(H코드)를 정확하게 표기하세요
2. MSDS 16개 항목 체계에 맞춰 해당 정보를 구조적으로 정리하세요
3. 응급조치요령, 취급·저장 방법, 노출방지·개인보호구 정보를 우선 제공하세요
4. GHS 분류에 따른 유해성·위험성 등급을 명시하세요
5. 관련 법규(산업안전보건법, 화학물질관리법 등) 인용 시 [1], [2] 형식 사용
6. 비교 질문 시 마크다운 표로 물질별 정보를 정리하세요
7. 문서에 없는 내용은 추측하지 마세요
8. **중요**: 이미지는 절대 직접 삽입하지 마세요. 관련 이미지는 시스템이 자동으로 표시합니다.""",
}

# Default system prompt (semiconductor/general domain)
DEFAULT_SYSTEM_PROMPT = """당신은 반도체 기술 전문가입니다.
제공된 문서들을 바탕으로 사용자의 질문에 대해 종합적이고 정확한 답변을 제공합니다.

답변 작성 지침:
1. 제공된 문서 내용을 기반으로 답변하세요
2. **중요**: 각 정보의 출처를 반드시 인용 번호로 표시하세요. 예: "CVD 공정은 화학 기상 증착 방식입니다[1]."
3. 인용 형식: 문장 끝에 [1], [2] 등의 번호를 붙여 어떤 문서에서 가져온 정보인지 명시하세요
4. 여러 문서의 내용을 종합할 때는 [1][3]처럼 복수 인용도 가능합니다
5. 기술 용어는 한글과 영문을 병기하세요
6. 핵심 포인트를 명확하게 구분하세요
7. 문서에 없는 내용은 추측하지 마세요
8. 마크다운 형식으로 가독성 있게 작성하세요
9. **중요**: 이미지는 절대 직접 삽입하지 마세요 (![image](...) 형식 사용 금지). 관련 이미지는 시스템이 자동으로 표시합니다."""

# Domain configurations
DOMAIN_CONFIG = {
    'semiconductor': {
        'title': '반도체 AI 검색',
        'icon': '🔬',
        'namespace': '',
        'color': '#00d4ff',
        'color_rgb': '0, 212, 255',
        'gradient_from': '#00d4ff',
        'gradient_to': '#0099cc',
        'description': '반도체 기술 문서 기반 AI 질의응답',
        'sample_questions': [
            'CVD와 PVD 공정의 차이점은 무엇인가요?',
            '반도체 패키징 공정에 대해 설명해주세요',
            '웨이퍼 제조 과정의 주요 단계는?'
        ],
        'features': ['공정 기술', '아키텍처', '제조 공정', '품질 관리']
    },
    'laborlaw': {
        'title': '노동법 AI 상담',
        'icon': '⚖️',
        'namespace': 'laborlaw',
        'color': '#ff9800',
        'color_rgb': '255, 152, 0',
        'gradient_from': '#ff9800',
        'gradient_to': '#f57c00',
        'description': '노동법 및 임금·보험료 계산 전문 AI',
        'sample_questions': [
            '연봉 5000만원 실수령액은 얼마인가요?',
            '세후 300만원 받으려면 월급이 얼마 필요한가요?',
            '일급 8만원인데 최저임금 위반인가요?',
            '4대보험료는 어떻게 계산하나요?'
        ],
        'features': ['임금 계산', '세후 역산', '4대보험', '최저임금', '근로기준법', '법률 상담']
    },
    'field-training': {
        'title': '현장실습 안전교육',
        'icon': '🏭',
        'namespace': 'field-training',
        'color': '#e91e63',
        'color_rgb': '233, 30, 99',
        'gradient_from': '#e91e63',
        'gradient_to': '#c2185b',
        'description': '직업계고 현장실습 안전보건 가이드',
        'sample_questions': [
            '연삭기 작업 시 안전수칙은?',
            '반도체 포토공정의 유해요인은?',
            '금속절삭기계 재해유형을 알려주세요',
            '현장실습생 건강관리 방법은?',
        ],
        'features': ['장비 안전', '유해요인', '안전수칙', '건강관리']
    },
    'safeguide': {
        'title': '안전보건 가이드',
        'icon': '🛡️',
        'namespace': 'safeguide',
        'color': '#2196f3',
        'color_rgb': '33, 150, 243',
        'gradient_from': '#2196f3',
        'gradient_to': '#1565c0',
        'description': '안전보건공단 공식 안전보건 교육자료 검색',
        'sample_questions': [
            '작업장 안전수칙을 알려주세요',
            '유해화학물질 취급 시 주의사항은?',
            '보호구 착용 기준을 설명해주세요',
            '산업재해 예방을 위한 안전관리는?'
        ],
        'features': ['안전수칙', '위험요인', '보호구', '예방대책']
    },
    'msds': {
        'title': 'MSDS 화학물질 정보',
        'icon': '🧪',
        'namespace': 'msds',
        'color': '#4caf50',
        'color_rgb': '76, 175, 80',
        'gradient_from': '#4caf50',
        'gradient_to': '#388e3c',
        'description': '산업안전보건공단 물질안전보건자료 검색',
        'sample_questions': [
            '벤젠의 안전 정보를 알려주세요',
            '에탄올의 유해성·위험성은?',
            '톨루엔의 응급조치요령을 찾아줘',
            'CAS 번호로 화학물질 검색'
        ],
        'features': ['화학물질 검색', 'MSDS 정보', '안전 데이터', 'CAS 번호 조회']
    }
}

# Reverse mapping: namespace → domain key (e.g. 'laborlaw' → 'laborlaw', '' → 'semiconductor')
NAMESPACE_DOMAIN_MAP = {}
for _key, _cfg in DOMAIN_CONFIG.items():
    _ns = _cfg['namespace']
    if _ns in NAMESPACE_DOMAIN_MAP:
        raise ValueError(
            f"DOMAIN_CONFIG namespace 충돌: '{_ns}' → "
            f"'{NAMESPACE_DOMAIN_MAP[_ns]}' vs '{_key}'"
        )
    NAMESPACE_DOMAIN_MAP[_ns] = _key

# Chain-of-Thought and visual guidelines (shared by ask and ask/stream)
COT_INSTRUCTIONS = """

## 답변 생성 프로세스

1. **이해 단계**: 질문의 핵심 의도를 파악하세요
2. **분석 단계**: 제공된 문서에서 관련 정보를 체계적으로 추출하세요
3. **종합 단계**: 추출된 정보를 논리적으로 구조화하세요
4. **검증 단계**: 답변이 질문에 완전히 답하는지 확인하세요

## 답변 구조화 지침

- **핵심 요약**: 먼저 1-2문장으로 핵심 답변 제시
- **상세 설명**: 관련 개념, 원리, 프로세스 설명
- **구체적 예시**: 가능한 경우 실제 사례나 수치 제시
- **추가 정보**: 관련된 보충 정보나 주의사항"""

VISUAL_GUIDELINES = """

## 시각적 표현 지침

1. **비교 정보**는 반드시 표(table)로 정리하세요
   예시:
   | 구분 | 항목1 | 항목2 |
   |------|-------|-------|
   | 특징 | 설명1 | 설명2 |

2. **프로세스/단계**는 순서 목록으로 정리하세요
3. **수치 데이터**가 있으면 정리해서 제시하세요 (차트로 시각화할 수 있도록)
4. **분류/종류**는 표나 목록으로 체계적으로 정리하세요

데이터 시각화 요청시:
- 수치 비교가 필요한 경우, 다음 JSON 형식으로 차트 데이터를 추가로 제공하세요:
<!--CHART_DATA
{
  "type": "bar|pie|line",
  "title": "차트 제목",
  "labels": ["라벨1", "라벨2"],
  "data": [수치1, 수치2],
  "unit": "단위"
}
CHART_DATA-->"""
