<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Pinecone Agent</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        /* Top Nav */
        .top-nav {
            width: 100%;
            background: rgba(0,0,0,0.4);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            z-index: 100;
        }
        .top-nav .back-link {
            color: #888;
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .top-nav .back-link:hover { color: #00d4ff; }
        .top-nav h1 {
            font-size: 1.2rem;
            color: #00d4ff;
            flex: 1;
        }
        .top-nav .user-info {
            color: #aaa;
            font-size: 0.85rem;
        }

        /* Layout */
        .admin-layout {
            display: flex;
            flex: 1;
            min-height: 0;
        }

        /* Sidebar */
        .sidebar {
            width: 220px;
            background: rgba(0,0,0,0.3);
            border-right: 1px solid rgba(255,255,255,0.08);
            padding: 20px 0;
            flex-shrink: 0;
            overflow-y: auto;
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            color: #999;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            border-left: 3px solid transparent;
        }
        .sidebar-item:hover {
            color: #e0e0e0;
            background: rgba(255,255,255,0.05);
        }
        .sidebar-item.active {
            color: #00d4ff;
            background: rgba(0,212,255,0.08);
            border-left-color: #00d4ff;
        }
        .sidebar-icon { font-size: 1.1rem; width: 24px; text-align: center; }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            min-width: 0;
        }
        .section { display: none; }
        .section.active { display: block; }
        .section-title {
            font-size: 1.5rem;
            color: #fff;
            margin-bottom: 24px;
        }

        /* Cards Grid */
        .stat-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .stat-card .stat-icon { font-size: 2rem; margin-bottom: 8px; }
        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #00d4ff;
        }
        .stat-card .stat-label {
            color: #888;
            font-size: 0.85rem;
            margin-top: 4px;
        }

        /* Tables */
        .table-wrapper {
            overflow-x: auto;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        th {
            background: rgba(0,0,0,0.3);
            padding: 12px 16px;
            text-align: left;
            color: #aaa;
            font-weight: 500;
            white-space: nowrap;
        }
        td {
            padding: 12px 16px;
            border-top: 1px solid rgba(255,255,255,0.06);
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        tr:hover td { background: rgba(255,255,255,0.03); }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            background: rgba(255,255,255,0.08);
            color: #e0e0e0;
            font-size: 0.82rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover { background: rgba(255,255,255,0.15); }
        .btn-primary {
            background: rgba(0,212,255,0.2);
            border-color: rgba(0,212,255,0.4);
            color: #00d4ff;
        }
        .btn-primary:hover { background: rgba(0,212,255,0.35); }
        .btn-danger {
            background: rgba(244,67,54,0.15);
            border-color: rgba(244,67,54,0.3);
            color: #f44336;
        }
        .btn-danger:hover { background: rgba(244,67,54,0.3); }
        .btn-success {
            background: rgba(76,175,80,0.15);
            border-color: rgba(76,175,80,0.3);
            color: #4caf50;
        }
        .btn-success:hover { background: rgba(76,175,80,0.3); }
        .btn-warning {
            background: rgba(255,152,0,0.15);
            border-color: rgba(255,152,0,0.3);
            color: #ff9800;
        }
        .btn-warning:hover { background: rgba(255,152,0,0.3); }
        .btn-group { display: flex; gap: 6px; flex-wrap: wrap; }
        .btn-sm { padding: 4px 10px; font-size: 0.78rem; }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .toolbar input, .toolbar select {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 8px 14px;
            color: #e0e0e0;
            font-size: 0.9rem;
            outline: none;
        }
        .toolbar input::placeholder { color: #666; }
        .toolbar input:focus, .toolbar select:focus {
            border-color: rgba(0,212,255,0.5);
        }
        .toolbar select option { background: #1a1a2e; }

        /* Pagination */
        .pagination {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination .btn.active {
            background: rgba(0,212,255,0.3);
            color: #00d4ff;
        }
        .page-info { color: #888; font-size: 0.85rem; }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-admin { background: rgba(0,212,255,0.2); color: #00d4ff; }
        .badge-user { background: rgba(255,255,255,0.1); color: #aaa; }
        .badge-active { background: rgba(76,175,80,0.2); color: #4caf50; }
        .badge-inactive { background: rgba(244,67,54,0.2); color: #f44336; }
        .badge-deleted { background: rgba(244,67,54,0.15); color: #f44336; }
        .badge-pinned { background: rgba(255,152,0,0.2); color: #ff9800; }
        .badge-indexed { background: rgba(76,175,80,0.2); color: #4caf50; }
        .badge-unindexed { background: rgba(33,150,243,0.2); color: #2196f3; }
        .badge-orphaned { background: rgba(255,152,0,0.2); color: #ff9800; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(0,0,0,0.85);
            border: 1px solid rgba(0,212,255,0.3);
            border-radius: 10px;
            padding: 14px 24px;
            color: #e0e0e0;
            font-size: 0.9rem;
            z-index: 9999;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { border-color: rgba(244,67,54,0.5); }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #1e2a3a;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }
        .modal h3 { color: #fff; margin-bottom: 20px; }
        .modal .form-group { margin-bottom: 16px; }
        .modal label { display: block; color: #aaa; margin-bottom: 6px; font-size: 0.85rem; }
        .modal input, .modal select {
            width: 100%;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 10px 14px;
            color: #e0e0e0;
            font-size: 0.9rem;
            outline: none;
        }
        .modal input:focus, .modal select:focus {
            border-color: rgba(0,212,255,0.5);
        }
        .modal select option { background: #1a1a2e; }
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        /* File Tree */
        .file-tree-container {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 16px;
            max-height: calc(100vh - 250px);
            overflow-y: auto;
        }
        .tree-folder {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #e0e0e0;
            transition: background 0.15s;
        }
        .tree-folder:hover { background: rgba(255,255,255,0.06); }
        .tree-folder .tree-arrow {
            width: 16px;
            text-align: center;
            font-size: 0.7rem;
            color: #888;
            transition: transform 0.2s;
            flex-shrink: 0;
        }
        .tree-folder.expanded .tree-arrow { transform: rotate(90deg); }
        .tree-folder .tree-icon { font-size: 1rem; flex-shrink: 0; }
        .tree-folder .tree-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .tree-folder .tree-count {
            color: #666;
            font-size: 0.78rem;
            flex-shrink: 0;
        }
        .tree-children {
            margin-left: 20px;
            display: none;
        }
        .tree-children.expanded { display: block; }
        .tree-file {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px 4px 28px;
            font-size: 0.85rem;
            color: #aaa;
            border-radius: 6px;
            transition: background 0.15s;
        }
        .tree-file:hover { background: rgba(255,255,255,0.04); color: #e0e0e0; }
        .tree-file .file-icon { font-size: 0.9rem; flex-shrink: 0; }
        .tree-file .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .tree-file .file-name a { color: inherit; text-decoration: none; }
        .tree-file .file-name a:hover { color: #00d4ff; }
        .tree-file .file-meta {
            color: #666;
            font-size: 0.75rem;
            flex-shrink: 0;
            display: flex;
            gap: 10px;
        }

        /* Sortable Headers */
        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 24px;
            transition: color 0.2s;
        }
        th.sortable:hover { color: #00d4ff; }
        th.sortable::after {
            content: 'â‡…';
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            opacity: 0.4;
        }
        th.sortable.asc::after {
            content: 'â–²';
            opacity: 1;
            color: #00d4ff;
        }
        th.sortable.desc::after {
            content: 'â–¼';
            opacity: 1;
            color: #00d4ff;
        }
        th.sortable.asc, th.sortable.desc { color: #00d4ff; }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-layout { flex-direction: column; }
            .sidebar {
                width: 100%;
                display: flex;
                overflow-x: auto;
                padding: 0;
                border-right: none;
                border-bottom: 1px solid rgba(255,255,255,0.08);
            }
            .sidebar-item {
                padding: 10px 16px;
                border-left: none;
                border-bottom: 3px solid transparent;
                white-space: nowrap;
                font-size: 0.85rem;
            }
            .sidebar-item.active { border-bottom-color: #00d4ff; border-left-color: transparent; }
            .main-content { padding: 20px; }
            .stat-cards { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <a href="/" class="back-link">â† Home</a>
        <h1>Admin Dashboard</h1>
        <span class="user-info">{{ current_user.name }} (ê´€ë¦¬ì)</span>
    </nav>

    <div class="admin-layout">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-item active" data-section="dashboard">
                <span class="sidebar-icon">ğŸ“Š</span> ëŒ€ì‹œë³´ë“œ
            </div>
            <div class="sidebar-item" data-section="documents">
                <span class="sidebar-icon">ğŸ“š</span> í•™ìŠµìë£Œ
            </div>
            <div class="sidebar-item" data-section="posts">
                <span class="sidebar-icon">ğŸ“</span> ê²Œì‹œíŒ
            </div>
            <div class="sidebar-item" data-section="users">
                <span class="sidebar-icon">ğŸ‘¥</span> ì‚¬ìš©ì
            </div>
            <div class="sidebar-item" data-section="stats">
                <span class="sidebar-icon">ğŸ“ˆ</span> í†µê³„
            </div>
            <div class="sidebar-item" data-section="logs">
                <span class="sidebar-icon">ğŸ“‹</span> í™œë™ë¡œê·¸
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">

            <!-- ===== Dashboard ===== -->
            <div id="section-dashboard" class="section active">
                <h2 class="section-title">ëŒ€ì‹œë³´ë“œ</h2>
                <div class="stat-cards" id="overview-cards">
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ“„</div>
                        <div class="stat-value" id="ov-documents">-</div>
                        <div class="stat-label">í•™ìŠµìë£Œ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ”¢</div>
                        <div class="stat-value" id="ov-vectors">-</div>
                        <div class="stat-label">ë²¡í„° ìˆ˜</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ‘¥</div>
                        <div class="stat-value" id="ov-users">-</div>
                        <div class="stat-label">ì‚¬ìš©ì</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ“</div>
                        <div class="stat-value" id="ov-posts">-</div>
                        <div class="stat-label">ê²Œì‹œê¸€</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ’¬</div>
                        <div class="stat-value" id="ov-comments">-</div>
                        <div class="stat-label">ëŒ“ê¸€</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ—‚ï¸</div>
                        <div class="stat-value" id="ov-namespaces">-</div>
                        <div class="stat-label">ë„¤ì„ìŠ¤í˜ì´ìŠ¤</div>
                    </div>
                </div>

                <h3 style="color:#fff;margin-bottom:16px;">ìµœê·¼ í™œë™ ë¡œê·¸</h3>
                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>ì‹œê°„</th><th>ê´€ë¦¬ì</th><th>ì•¡ì…˜</th><th>ëŒ€ìƒ</th><th>ìƒì„¸</th></tr></thead>
                        <tbody id="dashboard-logs"></tbody>
                    </table>
                </div>
            </div>

            <!-- ===== Documents ===== -->
            <div id="section-documents" class="section">
                <h2 class="section-title">í•™ìŠµìë£Œ ê´€ë¦¬</h2>
                <div class="toolbar">
                    <input type="text" id="doc-search" placeholder="íŒŒì¼ëª… ê²€ìƒ‰..." style="flex:1;min-width:200px;">
                    <select id="doc-ns-filter">
                        <option value="">ì „ì²´ ë„¤ì„ìŠ¤í˜ì´ìŠ¤</option>
                    </select>
                    <select id="doc-status-filter">
                        <option value="">ì „ì²´ ìƒíƒœ</option>
                        <option value="indexed">ìƒ‰ì¸ë¨</option>
                        <option value="unindexed">ë¯¸ìƒ‰ì¸</option>
                        <option value="orphaned">ê³ ì•„</option>
                    </select>
                    <select id="doc-type-filter">
                        <option value="" selected>ì „ì²´ íŒŒì¼</option>
                        <option value="md,pdf">ë¬¸ì„œ (md, pdf)</option>
                        <option value="md">ë§ˆí¬ë‹¤ìš´ë§Œ</option>
                        <option value="pdf">PDFë§Œ</option>
                        <option value="jpeg,jpg,png,gif,webp">ì´ë¯¸ì§€ë§Œ</option>
                        <option value="json">JSONë§Œ</option>
                    </select>
                    <button class="btn btn-primary" id="sync-fs-btn" onclick="syncFilesystem()">ğŸ“‚ íŒŒì¼ ë™ê¸°í™”</button>
                    <button class="btn" onclick="refreshFileTree()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    <span id="doc-tree-stats" style="color:#888;font-size:0.85rem;margin-left:auto;"></span>
                </div>

                <!-- Search Results (shown when searching) -->
                <div id="doc-search-results" style="display:none;">
                    <div class="table-wrapper">
                        <table id="doc-result-table">
                            <thead><tr>
                                <th class="sortable" data-sort="filename" onclick="sortDocuments('filename')">íŒŒì¼ëª…</th>
                                <th class="sortable" data-sort="namespace" onclick="sortDocuments('namespace')">ë„¤ì„ìŠ¤í˜ì´ìŠ¤</th>
                                <th class="sortable" data-sort="file_type" onclick="sortDocuments('file_type')">ìœ í˜•</th>
                                <th class="sortable" data-sort="vector_count" onclick="sortDocuments('vector_count')">ë²¡í„°</th>
                                <th class="sortable" data-sort="status" onclick="sortDocuments('status')">ìƒíƒœ</th>
                                <th class="sortable desc" data-sort="created_at" onclick="sortDocuments('created_at')">ë“±ë¡ì¼</th>
                                <th>ê´€ë¦¬</th>
                            </tr></thead>
                            <tbody id="doc-search-table"></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="doc-search-pagination"></div>
                </div>

                <!-- File Tree (shown by default) -->
                <div class="file-tree-container" id="file-tree">
                    <div class="loading">íŒŒì¼ íŠ¸ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>

            <!-- ===== Posts ===== -->
            <div id="section-posts" class="section">
                <h2 class="section-title">ê²Œì‹œíŒ ê´€ë¦¬</h2>

                <!-- Sub tabs: posts / categories -->
                <div style="display:flex;gap:12px;margin-bottom:20px;">
                    <button class="btn btn-primary post-tab active" data-tab="posts-tab" onclick="switchPostTab('posts-tab',this)">ê²Œì‹œê¸€</button>
                    <button class="btn post-tab" data-tab="categories-tab" onclick="switchPostTab('categories-tab',this)">ì¹´í…Œê³ ë¦¬</button>
                </div>

                <div id="posts-tab">
                    <div class="toolbar">
                        <input type="text" id="post-search" placeholder="ê²Œì‹œê¸€ ê²€ìƒ‰..." style="flex:1;min-width:200px;">
                        <select id="post-cat-filter">
                            <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                        </select>
                        <label style="display:flex;align-items:center;gap:6px;color:#aaa;font-size:0.85rem;cursor:pointer;">
                            <input type="checkbox" id="post-show-deleted" style="accent-color:#00d4ff;"> ì‚­ì œ í¬í•¨
                        </label>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead><tr><th>ID</th><th>ì¹´í…Œê³ ë¦¬</th><th>ì œëª©</th><th>ì‘ì„±ì</th><th>ì¡°íšŒ</th><th>ì¢‹ì•„ìš”</th><th>ìƒíƒœ</th><th>ì‘ì„±ì¼</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="post-table"></tbody>
                        </table>
                    </div>
                    <div class="pagination" id="post-pagination"></div>
                </div>

                <div id="categories-tab" style="display:none;">
                    <div class="toolbar">
                        <button class="btn btn-primary" onclick="openCategoryModal()">+ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead><tr><th>ìˆœì„œ</th><th>ì•„ì´ì½˜</th><th>ì´ë¦„</th><th>ìŠ¬ëŸ¬ê·¸</th><th>ìƒ‰ìƒ</th><th>ê²Œì‹œê¸€</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
                            <tbody id="cat-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ===== Users ===== -->
            <div id="section-users" class="section">
                <h2 class="section-title">ì‚¬ìš©ì ê´€ë¦¬</h2>
                <div class="toolbar">
                    <input type="text" id="user-search" placeholder="ì´ë¦„ ë˜ëŠ” ì´ë©”ì¼ ê²€ìƒ‰..." style="flex:1;min-width:200px;">
                    <select id="user-sort">
                        <option value="latest">ìµœê·¼ ê°€ì…ìˆœ</option>
                        <option value="name">ì´ë¦„ìˆœ</option>
                        <option value="login">ìµœê·¼ ë¡œê·¸ì¸ìˆœ</option>
                    </select>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>ID</th><th>ì´ë¦„</th><th>ì´ë©”ì¼</th><th>ì—­í• </th><th>ìƒíƒœ</th><th>ì†Œì…œ</th><th>ê²Œì‹œê¸€</th><th>ê°€ì…ì¼</th><th>ê´€ë¦¬</th></tr></thead>
                        <tbody id="user-table"></tbody>
                    </table>
                </div>
                <div class="pagination" id="user-pagination"></div>
            </div>

            <!-- ===== Stats ===== -->
            <div id="section-stats" class="section">
                <h2 class="section-title">í†µê³„</h2>

                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <h3 style="color:#fff;margin:0;">ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë³„ ë²¡í„° ë¶„í¬</h3>
                    <button class="btn btn-primary btn-sm" id="sync-vectors-btn" onclick="syncVectors()">ğŸ”„ Pinecone ë™ê¸°í™”</button>
                    <button class="btn btn-success btn-sm" id="folder-status-btn" onclick="updateFolderStatus()">ğŸ“Š í´ë” ìƒíƒœ ê°±ì‹ </button>
                    <span id="sync-status" style="color:#888;font-size:0.82rem;"></span>
                </div>
                <div class="table-wrapper" style="margin-bottom:30px;">
                    <table>
                        <thead><tr><th>ë„¤ì„ìŠ¤í˜ì´ìŠ¤</th><th>ë¬¸ì„œ ìˆ˜</th><th>ë²¡í„° ìˆ˜</th><th>ë¹„ìœ¨</th></tr></thead>
                        <tbody id="vector-table"></tbody>
                    </table>
                </div>

                <h3 style="color:#fff;margin-bottom:16px;">ì¹´í…Œê³ ë¦¬ë³„ ê²Œì‹œê¸€</h3>
                <div class="table-wrapper" style="margin-bottom:30px;">
                    <table>
                        <thead><tr><th>ì¹´í…Œê³ ë¦¬</th><th>ê²Œì‹œê¸€ ìˆ˜</th><th>ë¹„ìœ¨</th></tr></thead>
                        <tbody id="cat-stats-table"></tbody>
                    </table>
                </div>

                <h3 style="color:#fff;margin-bottom:16px;">ì†Œì…œ ë¡œê·¸ì¸ í˜„í™©</h3>
                <div class="table-wrapper" style="margin-bottom:30px;">
                    <table>
                        <thead><tr><th>ì œê³µì</th><th>ì‚¬ìš©ì ìˆ˜</th></tr></thead>
                        <tbody id="provider-table"></tbody>
                    </table>
                </div>
            </div>

            <!-- ===== Logs ===== -->
            <div id="section-logs" class="section">
                <h2 class="section-title">í™œë™ ë¡œê·¸</h2>
                <div class="toolbar">
                    <select id="log-action-filter">
                        <option value="">ì „ì²´ ì•¡ì…˜</option>
                        <option value="sync_filesystem">íŒŒì¼ ë™ê¸°í™”</option>
                        <option value="sync_documents">Pinecone ë™ê¸°í™”</option>
                        <option value="update_folder_status">í´ë” ìƒíƒœ ê°±ì‹ </option>
                        <option value="delete_document">ë¬¸ì„œ ì‚­ì œ</option>
                        <option value="delete_namespace">NS ì‚­ì œ</option>
                        <option value="pin_post">ê¸€ ê³ ì •</option>
                        <option value="unpin_post">ê¸€ ê³ ì •í•´ì œ</option>
                        <option value="restore_post">ê¸€ ë³µì›</option>
                        <option value="hard_delete_post">ê¸€ ì™„ì „ì‚­ì œ</option>
                        <option value="hard_delete_comment">ëŒ“ê¸€ ì™„ì „ì‚­ì œ</option>
                        <option value="create_category">ì¹´í…Œê³ ë¦¬ ìƒì„±</option>
                        <option value="update_category">ì¹´í…Œê³ ë¦¬ ìˆ˜ì •</option>
                        <option value="deactivate_category">ì¹´í…Œê³ ë¦¬ ë¹„í™œì„±í™”</option>
                        <option value="change_role">ì—­í•  ë³€ê²½</option>
                        <option value="activate_user">ì‚¬ìš©ì í™œì„±í™”</option>
                        <option value="deactivate_user">ì‚¬ìš©ì ë¹„í™œì„±í™”</option>
                    </select>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>ì‹œê°„</th><th>ê´€ë¦¬ì</th><th>ì•¡ì…˜</th><th>ëŒ€ìƒ ìœ í˜•</th><th>ëŒ€ìƒ ID</th><th>ìƒì„¸</th></tr></thead>
                        <tbody id="log-table"></tbody>
                    </table>
                </div>
                <div class="pagination" id="log-pagination"></div>
            </div>

        </main>
    </div>

    <!-- Category Modal -->
    <div class="modal-overlay" id="category-modal">
        <div class="modal">
            <h3 id="cat-modal-title">ì¹´í…Œê³ ë¦¬ ì¶”ê°€</h3>
            <input type="hidden" id="cat-edit-id">
            <div class="form-group">
                <label>ì´ë¦„</label>
                <input type="text" id="cat-name" placeholder="ì˜ˆ: ì§ˆë¬¸">
            </div>
            <div class="form-group">
                <label>ìŠ¬ëŸ¬ê·¸ (URLìš© ì˜ë¬¸)</label>
                <input type="text" id="cat-slug" placeholder="ì˜ˆ: qna">
            </div>
            <div class="form-group">
                <label>ì„¤ëª…</label>
                <input type="text" id="cat-desc" placeholder="ì¹´í…Œê³ ë¦¬ ì„¤ëª…">
            </div>
            <div style="display:flex;gap:12px;">
                <div class="form-group" style="flex:1;">
                    <label>ìƒ‰ìƒ</label>
                    <input type="color" id="cat-color" value="#00d4ff" style="padding:4px;height:40px;">
                </div>
                <div class="form-group" style="flex:1;">
                    <label>ì•„ì´ì½˜ (ì´ëª¨ì§€)</label>
                    <input type="text" id="cat-icon" placeholder="ğŸ’¬" maxlength="4">
                </div>
                <div class="form-group" style="flex:1;">
                    <label>ì •ë ¬ ìˆœì„œ</label>
                    <input type="number" id="cat-sort" value="0" min="0">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeCategoryModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveCategory()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
    const API = '/api/v1/admin';

    // ---------------------------------------------------------------------------
    // Utility
    // ---------------------------------------------------------------------------
    const CSRF_TOKEN = '{{ csrf_token() }}';

    async function apiFetch(path, opts = {}) {
        const csrfHeaders = opts.method && opts.method.toUpperCase() !== 'GET'
            ? { 'X-CSRFToken': CSRF_TOKEN } : {};
        const res = await fetch(`${API}${path}`, {
            headers: { 'Content-Type': 'application/json', ...csrfHeaders, ...opts.headers },
            ...opts,
        });
        const contentType = res.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (${res.status})`);
        }
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'API ì˜¤ë¥˜');
        return data;
    }

    function showToast(msg, isError = false) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = 'toast show' + (isError ? ' error' : '');
        setTimeout(() => t.className = 'toast', 3000);
    }

    function fmtDate(iso) {
        if (!iso) return '-';
        const d = new Date(iso);
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    function fmtNumber(n) {
        return (n || 0).toLocaleString();
    }

    function renderPagination(containerId, current, total, callback) {
        const c = document.getElementById(containerId);
        if (total <= 1) { c.innerHTML = ''; return; }
        let html = '';
        if (current > 1) html += `<button class="btn btn-sm" onclick="${callback}(${current-1})">â† ì´ì „</button>`;
        const start = Math.max(1, current - 2);
        const end = Math.min(total, current + 2);
        for (let i = start; i <= end; i++) {
            html += `<button class="btn btn-sm ${i===current?'active':''}" onclick="${callback}(${i})">${i}</button>`;
        }
        if (current < total) html += `<button class="btn btn-sm" onclick="${callback}(${current+1})">ë‹¤ìŒ â†’</button>`;
        html += `<span class="page-info">${current} / ${total}</span>`;
        c.innerHTML = html;
    }

    function escHtml(s) {
        const d = document.createElement('div');
        d.textContent = s || '';
        return d.innerHTML;
    }

    function truncateJson(obj, maxLen = 60) {
        if (!obj) return '-';
        const str = JSON.stringify(obj);
        if (str.length <= maxLen) return str;
        return [...str].slice(0, maxLen).join('') + '...';
    }

    // ---------------------------------------------------------------------------
    // Section Navigation
    // ---------------------------------------------------------------------------
    document.querySelectorAll('.sidebar-item').forEach(item => {
        item.addEventListener('click', () => {
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            const sec = item.dataset.section;
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('section-' + sec).classList.add('active');
            location.hash = sec;
            loaders[sec]?.();
        });
    });

    function switchPostTab(tab, btn) {
        document.getElementById('posts-tab').style.display = tab === 'posts-tab' ? '' : 'none';
        document.getElementById('categories-tab').style.display = tab === 'categories-tab' ? '' : 'none';
        document.querySelectorAll('.post-tab').forEach(b => b.classList.remove('active', 'btn-primary'));
        btn.classList.add('active', 'btn-primary');
        if (tab === 'categories-tab') loadCategories();
    }

    // ---------------------------------------------------------------------------
    // Dashboard
    // ---------------------------------------------------------------------------
    async function loadDashboard() {
        try {
            const { data } = await apiFetch('/stats/overview');
            document.getElementById('ov-documents').textContent = fmtNumber(data.total_documents);
            document.getElementById('ov-vectors').textContent = fmtNumber(data.total_vectors);
            document.getElementById('ov-users').textContent = fmtNumber(data.total_users);
            document.getElementById('ov-posts').textContent = fmtNumber(data.total_posts);
            document.getElementById('ov-comments').textContent = fmtNumber(data.total_comments);
            document.getElementById('ov-namespaces').textContent = fmtNumber(data.namespaces);
        } catch (e) { console.error(e); }

        try {
            const { data } = await apiFetch('/logs?per_page=10');
            const tb = document.getElementById('dashboard-logs');
            if (!data.logs.length) { tb.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#666;">ì•„ì§ í™œë™ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; return; }
            tb.innerHTML = data.logs.map(l => `<tr>
                <td>${fmtDate(l.created_at)}</td>
                <td>${escHtml(l.admin?.name || '-')}</td>
                <td>${escHtml(l.action)}</td>
                <td>${escHtml(l.target_type || '-')} ${l.target_id || ''}</td>
                <td title="${escHtml(JSON.stringify(l.details))}">${escHtml(truncateJson(l.details, 60))}</td>
            </tr>`).join('');
        } catch (e) { console.error(e); }
    }

    // ---------------------------------------------------------------------------
    // Documents â€“ File Tree
    // ---------------------------------------------------------------------------
    const FILE_ICONS = {
        md:'ğŸ“„', pdf:'ğŸ“•', json:'ğŸ“‹', jpeg:'ğŸ–¼ï¸', jpg:'ğŸ–¼ï¸',
        png:'ğŸ–¼ï¸', gif:'ğŸ–¼ï¸', webp:'ğŸ–¼ï¸', xlsx:'ğŸ“Š', csv:'ğŸ“Š',
        html:'ğŸŒ', default:'ğŸ“'
    };
    const FOLDER_ICONS = {
        laborlaw:'âš–ï¸', ncs:'ğŸ”¬', 'ì•ˆì „ë³´ê±´ê³µë‹¨':'ğŸ­', 'í˜„ì¥ì‹¤ìŠµ':'ğŸ“',
        data:'ğŸ’¾', cases:'ğŸ“', laws:'ğŸ“œ', pdfs:'ğŸ“•',
        report:'ğŸ“Š', old_markdown:'ğŸ“', default:'ğŸ“'
    };
    function getFileIcon(ext) { return FILE_ICONS[ext] || FILE_ICONS.default; }
    function getFolderIcon(name) { return FOLDER_ICONS[name] || FOLDER_ICONS.default; }
    function formatFileSize(bytes) {
        if (!bytes) return '';
        if (bytes < 1024) return bytes + 'B';
        if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + 'KB';
        return (bytes/(1024*1024)).toFixed(1) + 'MB';
    }
    function getFileTypeFilter() {
        return document.getElementById('doc-type-filter').value;
    }

    async function loadFileTree(path, container) {
        const fileTypes = getFileTypeFilter();
        const params = new URLSearchParams();
        if (path) params.set('path', path);
        if (fileTypes) params.set('file_types', fileTypes);
        try {
            const { data } = await apiFetch(`/filetree?${params}`);
            if (!container) {
                container = document.getElementById('file-tree');
                container.innerHTML = '';
                const totalDirs = data.directories.length;
                const totalFiles = data.files.length;
                document.getElementById('doc-tree-stats').textContent =
                    `${totalDirs}ê°œ í´ë”, ${totalFiles}ê°œ íŒŒì¼`;
            }
            data.directories.forEach(dir => container.appendChild(createFolderNode(dir)));
            data.files.forEach(file => container.appendChild(createFileNode(file)));
            if (!data.directories.length && !data.files.length) {
                const empty = document.createElement('div');
                empty.style.cssText = 'color:#666;padding:8px 28px;font-size:0.85rem;';
                empty.textContent = '(ë¹„ì–´ìˆìŒ)';
                container.appendChild(empty);
            }
        } catch (e) { showToast(e.message, true); }
    }

    function createFolderNode(dir) {
        const wrapper = document.createElement('div');
        const folder = document.createElement('div');
        folder.className = 'tree-folder';
        folder.dataset.path = dir.path;
        folder.dataset.loaded = 'false';
        const parts = [];
        if (dir.dir_count > 0) parts.push(dir.dir_count + 'í´ë”');
        if (dir.file_count > 0) parts.push(dir.file_count + 'íŒŒì¼');
        folder.innerHTML = `
            <span class="tree-arrow">â–¶</span>
            <span class="tree-icon">${getFolderIcon(dir.name)}</span>
            <span class="tree-name" title="${escHtml(dir.path)}">${escHtml(dir.name)}</span>
            <span class="tree-count">${parts.join(', ')}</span>`;
        const children = document.createElement('div');
        children.className = 'tree-children';
        folder.addEventListener('click', async () => {
            const expanded = folder.classList.toggle('expanded');
            children.classList.toggle('expanded', expanded);
            if (expanded && folder.dataset.loaded === 'false') {
                folder.dataset.loaded = 'true';
                children.innerHTML = '<div style="color:#666;padding:4px 8px;font-size:0.85rem;">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
                await loadFileTree(dir.path, children);
            }
        });
        wrapper.appendChild(folder);
        wrapper.appendChild(children);
        return wrapper;
    }

    function createFileNode(file) {
        const node = document.createElement('div');
        node.className = 'tree-file';
        const docUrl = '/documents/' + file.path.split('/').map(encodeURIComponent).join('/');
        const viewable = ['pdf','md','jpeg','jpg','png','gif','webp'].includes(file.extension);
        node.innerHTML = `
            <span class="file-icon">${getFileIcon(file.extension)}</span>
            <span class="file-name" title="${escHtml(file.path)}">
                ${viewable ? `<a href="${docUrl}" target="_blank">${escHtml(file.name)}</a>` : escHtml(file.name)}
            </span>
            <span class="file-meta">
                <span>${escHtml(file.extension.toUpperCase())}</span>
                <span>${formatFileSize(file.size)}</span>
            </span>`;
        return node;
    }

    async function refreshFileTree() {
        try {
            await apiFetch('/filetree/refresh', { method: 'POST' });
            showToast('íŒŒì¼ íŠ¸ë¦¬ê°€ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (e) { showToast(e.message, true); }
        document.getElementById('file-tree').innerHTML = '<div class="loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        await loadFileTree();
    }

    document.getElementById('doc-type-filter').addEventListener('change', () => {
        if (!document.getElementById('doc-search').value.trim()) {
            document.getElementById('file-tree').innerHTML = '<div class="loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            loadFileTree();
        }
    });

    // ---------------------------------------------------------------------------
    // Documents â€“ Search (DB-backed indexed documents)
    // ---------------------------------------------------------------------------
    let docSearchPage = 1;
    let docSortBy = 'created_at';
    let docSortOrder = 'desc';

    function sortDocuments(column) {
        if (docSortBy === column) {
            docSortOrder = docSortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            docSortBy = column;
            docSortOrder = 'asc';
        }
        // Update header indicators
        document.querySelectorAll('#doc-result-table th.sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
            if (th.dataset.sort === docSortBy) {
                th.classList.add(docSortOrder);
            }
        });
        searchDocuments(1);
    }

    async function loadDocNamespaces() {
        try {
            const { data: vectors } = await apiFetch('/stats/vectors');
            const sel = document.getElementById('doc-ns-filter');
            sel.innerHTML = '<option value="">ì „ì²´ ë„¤ì„ìŠ¤í˜ì´ìŠ¤</option>';
            vectors.forEach(v => {
                sel.innerHTML += `<option value="${escHtml(v.namespace)}">${escHtml(v.namespace)} (${fmtNumber(v.documents)})</option>`;
            });
        } catch (e) { /* ignore */ }
    }

    const STATUS_LABELS = { indexed: 'ìƒ‰ì¸ë¨', unindexed: 'ë¯¸ìƒ‰ì¸', orphaned: 'ê³ ì•„' };

    function docStatusBadge(status) {
        const label = STATUS_LABELS[status] || status;
        return `<span class="badge badge-${status}">${escHtml(label)}</span>`;
    }

    function hasDocFilters() {
        return document.getElementById('doc-search').value.trim()
            || document.getElementById('doc-ns-filter').value
            || document.getElementById('doc-status-filter').value;
    }

    async function searchDocuments(page = 1) {
        docSearchPage = page;
        const search = document.getElementById('doc-search').value.trim();
        const ns = document.getElementById('doc-ns-filter').value;
        const status = document.getElementById('doc-status-filter').value;

        // If no filters active, show file tree
        if (!search && !ns && !status) {
            document.getElementById('doc-search-results').style.display = 'none';
            document.getElementById('file-tree').style.display = '';
            document.getElementById('doc-tree-stats').textContent = '';
            return;
        }

        // Show search results, hide file tree
        document.getElementById('doc-search-results').style.display = '';
        document.getElementById('file-tree').style.display = 'none';

        try {
            const params = new URLSearchParams({ page, per_page: 20, sort_by: docSortBy, sort_order: docSortOrder });
            if (search) params.set('search', search);
            if (ns) params.set('namespace', ns);
            if (status) params.set('status', status);

            const { data } = await apiFetch(`/documents?${params}`);
            const tb = document.getElementById('doc-search-table');
            document.getElementById('doc-tree-stats').textContent = `ê²€ìƒ‰ ê²°ê³¼: ${fmtNumber(data.total)}ê±´`;

            if (!data.documents.length) {
                tb.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#666;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            } else {
                tb.innerHTML = data.documents.map(d => {
                    const ext = d.file_type || '-';
                    const icon = FILE_ICONS[ext] || FILE_ICONS.default;
                    return `<tr>
                        <td title="${escHtml(d.source_file)}">${icon} ${escHtml(d.filename)}</td>
                        <td>${escHtml(d.namespace || '(ê¸°ë³¸)')}</td>
                        <td>${escHtml(ext.toUpperCase())}</td>
                        <td>${fmtNumber(d.vector_count)}</td>
                        <td>${docStatusBadge(d.status)}</td>
                        <td>${fmtDate(d.created_at)}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" data-action="delete-doc" data-id="${d.id}" data-filename="${escHtml(d.filename)}">ì‚­ì œ</button>
                        </td>
                    </tr>`;
                }).join('');
            }
            renderPagination('doc-search-pagination', data.current_page, data.pages, 'searchDocuments');
        } catch (e) { showToast(e.message, true); }
    }

    async function deleteDocument(id, name) {
        if (!confirm(`"${name}" ë¬¸ì„œë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. Pinecone ë²¡í„°ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        try {
            await apiFetch(`/documents/${id}`, { method: 'DELETE' });
            showToast('ë¬¸ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            searchDocuments(docSearchPage);
        } catch (e) { showToast(e.message, true); }
    }

    async function syncFilesystem() {
        const btn = document.getElementById('sync-fs-btn');
        btn.disabled = true;
        btn.textContent = 'â³ ë™ê¸°í™” ì¤‘...';
        try {
            const { message } = await apiFetch('/documents/sync-filesystem', { method: 'POST' });
            showToast(message);
            // Show unindexed documents in table after sync
            document.getElementById('doc-status-filter').value = 'unindexed';
            searchDocuments(1);
        } catch (e) {
            showToast('íŒŒì¼ ë™ê¸°í™” ì‹¤íŒ¨: ' + e.message, true);
        } finally {
            btn.disabled = false;
            btn.textContent = 'ğŸ“‚ íŒŒì¼ ë™ê¸°í™”';
        }
    }

    document.getElementById('doc-search').addEventListener('input', debounce(() => searchDocuments(1), 400));
    document.getElementById('doc-status-filter').addEventListener('change', () => searchDocuments(1));
    document.getElementById('doc-ns-filter').addEventListener('change', () => {
        if (hasDocFilters()) {
            searchDocuments(1);
        } else {
            document.getElementById('doc-search-results').style.display = 'none';
            document.getElementById('file-tree').style.display = '';
            document.getElementById('file-tree').innerHTML = '<div class="loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            loadFileTree();
        }
    });

    // ---------------------------------------------------------------------------
    // Posts
    // ---------------------------------------------------------------------------
    let postPage = 1;
    async function loadPosts(page = 1) {
        postPage = page;
        const search = document.getElementById('post-search').value;
        const cat = document.getElementById('post-cat-filter').value;
        const deleted = document.getElementById('post-show-deleted').checked;
        try {
            const params = new URLSearchParams({ page, per_page: 20 });
            if (search) params.set('search', search);
            if (cat) params.set('category', cat);
            if (deleted) params.set('deleted', 'true');

            const { data } = await apiFetch(`/posts?${params}`);
            const tb = document.getElementById('post-table');
            if (!data.posts.length) {
                tb.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#666;">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            } else {
                tb.innerHTML = data.posts.map(p => {
                    let statusBadges = '';
                    if (p.is_deleted) statusBadges += '<span class="badge badge-deleted">ì‚­ì œ</span> ';
                    if (p.is_pinned) statusBadges += '<span class="badge badge-pinned">ê³ ì •</span>';
                    if (!p.is_deleted && !p.is_pinned) statusBadges = '-';
                    return `<tr>
                        <td>${p.id}</td>
                        <td>${escHtml(p.category?.name || '-')}</td>
                        <td title="${escHtml(p.title)}">${escHtml(p.title)}</td>
                        <td>${escHtml(p.author?.name || '-')}</td>
                        <td>${fmtNumber(p.view_count)}</td>
                        <td>${fmtNumber(p.like_count)}</td>
                        <td>${statusBadges}</td>
                        <td>${fmtDate(p.created_at)}</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm ${p.is_pinned?'btn-warning':'btn'}" data-action="toggle-pin" data-id="${p.id}">${p.is_pinned?'ê³ ì •í•´ì œ':'ê³ ì •'}</button>
                                ${p.is_deleted ? `<button class="btn btn-success btn-sm" data-action="restore-post" data-id="${p.id}">ë³µì›</button>` : ''}
                                <button class="btn btn-danger btn-sm" data-action="hard-delete-post" data-id="${p.id}">ì™„ì „ì‚­ì œ</button>
                            </div>
                        </td>
                    </tr>`;
                }).join('');
            }
            renderPagination('post-pagination', data.current_page, data.pages, 'loadPosts');
        } catch (e) { showToast(e.message, true); }
    }

    async function loadPostCategories() {
        try {
            const res = await fetch('/api/v1/community/categories');
            const { data } = await res.json();
            const sel = document.getElementById('post-cat-filter');
            sel.innerHTML = '<option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>';
            data.forEach(c => sel.innerHTML += `<option value="${c.slug}">${c.name}</option>`);
        } catch (e) { /* ignore */ }
    }

    async function togglePin(id) {
        try {
            const { message } = await apiFetch(`/posts/${id}/pin`, { method: 'PUT' });
            showToast(message);
            loadPosts(postPage);
        } catch (e) { showToast(e.message, true); }
    }

    async function restorePost(id) {
        try {
            const { message } = await apiFetch(`/posts/${id}/restore`, { method: 'PUT' });
            showToast(message);
            loadPosts(postPage);
        } catch (e) { showToast(e.message, true); }
    }

    async function hardDeletePost(id) {
        if (!confirm('ì´ ê²Œì‹œê¸€ì„ ì™„ì „íˆ ì‚­ì œí•©ë‹ˆë‹¤. ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            await apiFetch(`/posts/${id}/hard`, { method: 'DELETE' });
            showToast('ê²Œì‹œê¸€ì´ ì™„ì „íˆ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadPosts(postPage);
        } catch (e) { showToast(e.message, true); }
    }

    document.getElementById('post-search').addEventListener('input', debounce(() => loadPosts(1), 400));
    document.getElementById('post-cat-filter').addEventListener('change', () => loadPosts(1));
    document.getElementById('post-show-deleted').addEventListener('change', () => loadPosts(1));

    // ---------------------------------------------------------------------------
    // Categories
    // ---------------------------------------------------------------------------
    async function loadCategories() {
        try {
            const { data } = await apiFetch('/categories');
            const tb = document.getElementById('cat-table');
            tb.innerHTML = data.map(c => `<tr>
                <td>${c.sort_order}</td>
                <td>${escHtml(c.icon || '-')}</td>
                <td>${escHtml(c.name)}</td>
                <td>${escHtml(c.slug)}</td>
                <td><span style="display:inline-block;width:20px;height:20px;border-radius:4px;background:${c.color};vertical-align:middle;"></span> ${c.color}</td>
                <td>${fmtNumber(c.post_count)}</td>
                <td><span class="badge badge-${c.is_active?'active':'inactive'}">${c.is_active?'í™œì„±':'ë¹„í™œì„±'}</span></td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm edit-cat-btn" data-category="${escHtml(JSON.stringify(c))}">ìˆ˜ì •</button>
                        ${c.is_active ? `<button class="btn btn-danger btn-sm deactivate-cat-btn" data-id="${c.id}">ë¹„í™œì„±í™”</button>` : ''}
                    </div>
                </td>
            </tr>`).join('');
        } catch (e) { showToast(e.message, true); }
    }

    function openCategoryModal() {
        document.getElementById('cat-modal-title').textContent = 'ì¹´í…Œê³ ë¦¬ ì¶”ê°€';
        document.getElementById('cat-edit-id').value = '';
        document.getElementById('cat-name').value = '';
        document.getElementById('cat-slug').value = '';
        document.getElementById('cat-desc').value = '';
        document.getElementById('cat-color').value = '#00d4ff';
        document.getElementById('cat-icon').value = '';
        document.getElementById('cat-sort').value = '0';
        document.getElementById('category-modal').classList.add('active');
    }

    // Event delegation for category buttons (prevents XSS from inline onclick)
    document.addEventListener('click', e => {
        const editBtn = e.target.closest('.edit-cat-btn');
        if (editBtn) {
            const c = JSON.parse(editBtn.dataset.category);
            document.getElementById('cat-modal-title').textContent = 'ì¹´í…Œê³ ë¦¬ ìˆ˜ì •';
            document.getElementById('cat-edit-id').value = c.id;
            document.getElementById('cat-name').value = c.name;
            document.getElementById('cat-slug').value = c.slug;
            document.getElementById('cat-slug').disabled = true;
            document.getElementById('cat-desc').value = c.description || '';
            document.getElementById('cat-color').value = c.color;
            document.getElementById('cat-icon').value = c.icon || '';
            document.getElementById('cat-sort').value = c.sort_order;
            document.getElementById('category-modal').classList.add('active');
            return;
        }
        const deactivateBtn = e.target.closest('.deactivate-cat-btn');
        if (deactivateBtn) {
            const id = deactivateBtn.dataset.id;
            if (!confirm('ì´ ì¹´í…Œê³ ë¦¬ë¥¼ ë¹„í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            apiFetch(`/categories/${id}`, { method: 'DELETE' })
                .then(() => { showToast('ì¹´í…Œê³ ë¦¬ê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.'); loadCategories(); })
                .catch(e => showToast(e.message, true));
        }
    });

    function closeCategoryModal() {
        document.getElementById('category-modal').classList.remove('active');
        document.getElementById('cat-slug').disabled = false;
    }

    async function saveCategory() {
        const id = document.getElementById('cat-edit-id').value;
        const body = {
            name: document.getElementById('cat-name').value,
            slug: document.getElementById('cat-slug').value,
            description: document.getElementById('cat-desc').value,
            color: document.getElementById('cat-color').value,
            icon: document.getElementById('cat-icon').value,
            sort_order: parseInt(document.getElementById('cat-sort').value) || 0,
        };
        try {
            if (id) {
                await apiFetch(`/categories/${id}`, { method: 'PUT', body: JSON.stringify(body) });
            } else {
                await apiFetch('/categories', { method: 'POST', body: JSON.stringify(body) });
            }
            showToast('ì¹´í…Œê³ ë¦¬ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeCategoryModal();
            loadCategories();
        } catch (e) { showToast(e.message, true); }
    }

    // ---------------------------------------------------------------------------
    // Users
    // ---------------------------------------------------------------------------
    let userPage = 1;
    async function loadUsers(page = 1) {
        userPage = page;
        const search = document.getElementById('user-search').value;
        const sort = document.getElementById('user-sort').value;
        try {
            const params = new URLSearchParams({ page, per_page: 20, sort });
            if (search) params.set('search', search);

            const { data } = await apiFetch(`/users?${params}`);
            const tb = document.getElementById('user-table');
            if (!data.users.length) {
                tb.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#666;">ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            } else {
                tb.innerHTML = data.users.map(u => `<tr>
                    <td>${u.id}</td>
                    <td>${escHtml(u.name)}</td>
                    <td>${escHtml(u.email)}</td>
                    <td><span class="badge badge-${u.role}">${u.role}</span></td>
                    <td><span class="badge badge-${u.is_active?'active':'inactive'}">${u.is_active?'í™œì„±':'ë¹„í™œì„±'}</span></td>
                    <td>${(u.providers||[]).join(', ') || '-'}</td>
                    <td>${u.post_count || 0}</td>
                    <td>${fmtDate(u.created_at)}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm" data-action="toggle-role" data-id="${u.id}" data-role="${escHtml(u.role)}">${u.role==='admin'?'ì¼ë°˜ìœ¼ë¡œ':'ê´€ë¦¬ìë¡œ'}</button>
                            <button class="btn btn-sm ${u.is_active?'btn-danger':'btn-success'}" data-action="toggle-active" data-id="${u.id}">${u.is_active?'ë¹„í™œì„±í™”':'í™œì„±í™”'}</button>
                        </div>
                    </td>
                </tr>`).join('');
            }
            renderPagination('user-pagination', data.current_page, data.pages, 'loadUsers');
        } catch (e) { showToast(e.message, true); }
    }

    async function toggleRole(id, currentRole) {
        const newRole = currentRole === 'admin' ? 'user' : 'admin';
        if (!confirm(`ì´ ì‚¬ìš©ìì˜ ì—­í• ì„ '${newRole}'(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        try {
            const { message } = await apiFetch(`/users/${id}/role`, {
                method: 'PUT',
                body: JSON.stringify({ role: newRole }),
            });
            showToast(message);
            loadUsers(userPage);
        } catch (e) { showToast(e.message, true); }
    }

    async function toggleActive(id) {
        try {
            const { message } = await apiFetch(`/users/${id}/active`, { method: 'PUT' });
            showToast(message);
            loadUsers(userPage);
        } catch (e) { showToast(e.message, true); }
    }

    document.getElementById('user-search').addEventListener('input', debounce(() => loadUsers(1), 400));
    document.getElementById('user-sort').addEventListener('change', () => loadUsers(1));

    // ---------------------------------------------------------------------------
    // Stats
    // ---------------------------------------------------------------------------
    async function loadStats() {
        try {
            const { data: vectors } = await apiFetch('/stats/vectors');
            const totalVec = vectors.reduce((s, v) => s + v.vectors, 0);
            document.getElementById('vector-table').innerHTML = vectors.map(v => `<tr>
                <td>${escHtml(v.namespace)}</td>
                <td>${fmtNumber(v.documents)}</td>
                <td>${fmtNumber(v.vectors)}</td>
                <td>${totalVec ? Math.round(v.vectors / totalVec * 100) : 0}%</td>
            </tr>`).join('') || '<tr><td colspan="4" style="text-align:center;color:#666;">ë°ì´í„° ì—†ìŒ</td></tr>';
        } catch (e) { /* ignore */ }

        try {
            const { data: comm } = await apiFetch('/stats/community');
            const totalPosts = comm.category_distribution.reduce((s, c) => s + c.count, 0);
            document.getElementById('cat-stats-table').innerHTML = comm.category_distribution.map(c => `<tr>
                <td>${escHtml(c.category)}</td>
                <td>${fmtNumber(c.count)}</td>
                <td>${totalPosts ? Math.round(c.count / totalPosts * 100) : 0}%</td>
            </tr>`).join('') || '<tr><td colspan="3" style="text-align:center;color:#666;">ë°ì´í„° ì—†ìŒ</td></tr>';
        } catch (e) { /* ignore */ }

        try {
            const { data: users } = await apiFetch('/stats/users');
            document.getElementById('provider-table').innerHTML = users.providers.map(p => `<tr>
                <td>${escHtml(p.provider)}</td>
                <td>${fmtNumber(p.count)}</td>
            </tr>`).join('') || '<tr><td colspan="2" style="text-align:center;color:#666;">ë°ì´í„° ì—†ìŒ</td></tr>';
        } catch (e) { /* ignore */ }
    }

    async function syncVectors() {
        const btn = document.getElementById('sync-vectors-btn');
        const status = document.getElementById('sync-status');
        btn.disabled = true;
        btn.textContent = 'â³ ë™ê¸°í™” ì¤‘...';
        status.textContent = 'Pinecone í†µê³„ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
        try {
            const { data, message } = await apiFetch('/documents/sync', { method: 'POST' });
            showToast(message);
            status.textContent = `ë™ê¸°í™” ì™„ë£Œ: ì´ ${fmtNumber(data.total_vectors)}ê°œ ë²¡í„°, ${data.folder_updated}ê°œ í•™ìŠµìë£Œ ê°±ì‹ `;
            loadStats();
        } catch (e) {
            showToast('ë™ê¸°í™” ì‹¤íŒ¨: ' + e.message, true);
            status.textContent = 'ë™ê¸°í™” ì‹¤íŒ¨';
        } finally {
            btn.disabled = false;
            btn.textContent = 'ğŸ”„ Pinecone ë™ê¸°í™”';
        }
    }

    // ---------------------------------------------------------------------------
    // Logs
    // ---------------------------------------------------------------------------
    let logPage = 1;
    async function loadLogs(page = 1) {
        logPage = page;
        const action = document.getElementById('log-action-filter').value;
        try {
            const params = new URLSearchParams({ page, per_page: 30 });
            if (action) params.set('action', action);

            const { data } = await apiFetch(`/logs?${params}`);
            const tb = document.getElementById('log-table');
            if (!data.logs.length) {
                tb.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#666;">í™œë™ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            } else {
                tb.innerHTML = data.logs.map(l => `<tr>
                    <td>${fmtDate(l.created_at)}</td>
                    <td>${escHtml(l.admin?.name || '-')}</td>
                    <td>${escHtml(l.action)}</td>
                    <td>${escHtml(l.target_type || '-')}</td>
                    <td>${l.target_id || '-'}</td>
                    <td title="${escHtml(JSON.stringify(l.details))}">${escHtml(truncateJson(l.details, 80))}</td>
                </tr>`).join('');
            }
            renderPagination('log-pagination', data.current_page, data.pages, 'loadLogs');
        } catch (e) { showToast(e.message, true); }
    }

    async function updateFolderStatus() {
        const btn = document.getElementById('folder-status-btn');
        const status = document.getElementById('sync-status');
        btn.disabled = true;
        btn.textContent = 'â³ ê°±ì‹  ì¤‘...';
        status.textContent = 'DBì—ì„œ í´ë” ìƒíƒœë¥¼ ê³„ì‚°í•˜ëŠ” ì¤‘...';
        try {
            const { data, message } = await apiFetch('/documents/update-folder-status', { method: 'POST' });
            showToast(message);
            status.textContent = `ê°±ì‹  ì™„ë£Œ: ${data.updated}ê°œ ìƒ‰ì¸ë¨` + (data.duplicates ? `, ${data.duplicates}ê°œ ì¤‘ë³µ` : '') + `, ${data.still_unindexed}ê°œ ë¯¸ìƒ‰ì¸`;
            // Refresh vector stats table
            loadStats();
        } catch (e) {
            showToast('í´ë” ìƒíƒœ ê°±ì‹  ì‹¤íŒ¨: ' + e.message, true);
            status.textContent = 'ê°±ì‹  ì‹¤íŒ¨';
        } finally {
            btn.disabled = false;
            btn.textContent = 'ğŸ“Š í´ë” ìƒíƒœ ê°±ì‹ ';
        }
    }

    document.getElementById('log-action-filter').addEventListener('change', () => loadLogs(1));

    // ---------------------------------------------------------------------------
    // Debounce helper
    // ---------------------------------------------------------------------------
    function debounce(fn, ms) {
        let t;
        return function(...args) { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), ms); };
    }

    // ---------------------------------------------------------------------------
    // Event delegation for data-action buttons (XSS-safe)
    // ---------------------------------------------------------------------------
    document.addEventListener('click', e => {
        const btn = e.target.closest('[data-action]');
        if (!btn) return;
        const id = parseInt(btn.dataset.id);
        switch (btn.dataset.action) {
            case 'delete-doc':
                deleteDocument(id, btn.dataset.filename);
                break;
            case 'toggle-pin':
                togglePin(id);
                break;
            case 'restore-post':
                restorePost(id);
                break;
            case 'hard-delete-post':
                hardDeletePost(id);
                break;
            case 'toggle-role':
                toggleRole(id, btn.dataset.role);
                break;
            case 'toggle-active':
                toggleActive(id);
                break;
        }
    });

    // ---------------------------------------------------------------------------
    // Section loader map + init
    // ---------------------------------------------------------------------------
    const loaders = {
        dashboard: loadDashboard,
        documents: () => { loadDocNamespaces(); loadFileTree(); },
        posts: () => { loadPostCategories(); loadPosts(); },
        users: loadUsers,
        stats: loadStats,
        logs: loadLogs,
    };

    // Init: navigate from hash or default to dashboard
    (function init() {
        const hash = location.hash.replace('#', '') || 'dashboard';
        const item = document.querySelector(`.sidebar-item[data-section="${hash}"]`);
        if (item) item.click();
        else loadDashboard();
    })();
    </script>
</body>
</html>
