<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì»¤ë®¤ë‹ˆí‹° - Pinecone Agent</title>
    <script defer src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/dompurify@3.2.4/dist/purify.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        /* ===== Top Navigation ===== */
        .top-nav {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 0;
            margin-bottom: 20px;
        }
        .top-nav .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .top-nav .home-link {
            font-size: 1.1rem;
            flex-shrink: 0;
        }
        .top-nav .nav-links {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .top-nav a {
            color: #fff;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s;
            white-space: nowrap;
        }
        .top-nav a:hover { color: #7c4dff; }
        .top-nav .user-name { color: #ccc; font-size: 0.9rem; }
        .top-nav .user-avatar {
            width: 26px; height: 26px; border-radius: 50%;
            object-fit: cover;
        }
        .top-nav .user-section {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: 20px;
            padding-left: 20px;
            border-left: 1px solid rgba(255,255,255,0.15);
        }
        .top-nav .btn-login-sm {
            background: rgba(255,255,255,0.1);
            padding: 5px 14px;
            border-radius: 6px;
            color: #ccc;
            font-size: 0.85rem;
            margin-left: 20px;
        }
        .top-nav .btn-login-sm:hover { background: rgba(255,255,255,0.2); color: #fff; }
        .top-nav .admin-link {
            color: #00d4ff !important;
        }
        .top-nav .btn-logout {
            background: none; border: none; cursor: pointer;
            font: inherit; color: #fff; padding: 0; font-size: 0.9rem;
            transition: color 0.3s;
        }
        .top-nav .btn-logout:hover { color: #7c4dff; }

        /* ===== Container ===== */
        .container { max-width: 1200px; width: 100%; margin: 0 auto; padding: 20px; }

        /* ===== Main Panel (matches domain.html) ===== */
        .main-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 30px;
            padding: 30px;
        }

        /* ===== Page Header ===== */
        .page-header { text-align: center; padding: 40px 0; }
        .page-header h1 { font-size: 2.5rem; color: #7c4dff; margin-bottom: 10px; }
        .page-header p { color: #888; font-size: 1.1rem; }

        /* ===== Category Tabs ===== */
        .category-tabs {
            display: flex; gap: 8px; margin-bottom: 16px;
            overflow-x: auto; padding-bottom: 4px;
        }
        .category-tabs::-webkit-scrollbar { height: 3px; }
        .category-tabs::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
        .tab-btn {
            padding: 8px 18px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.05); color: #aaa; font-size: 0.9rem;
            cursor: pointer; white-space: nowrap; transition: all 0.2s;
        }
        .tab-btn:hover { background: rgba(255,255,255,0.1); color: #e0e0e0; }
        .tab-btn.active { background: rgba(124, 77, 255, 0.2); color: #7c4dff; border-color: rgba(124, 77, 255, 0.4); }

        /* ===== Toolbar ===== */
        .toolbar {
            display: flex; gap: 10px; margin-bottom: 16px; align-items: center; flex-wrap: wrap;
        }
        .toolbar input[type="text"] {
            flex: 1; min-width: 180px; padding: 10px 14px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.3);
            color: #e0e0e0; font-size: 0.9rem; outline: none; transition: border-color 0.2s;
        }
        .toolbar input[type="text"]:focus { border-color: #7c4dff; }
        .toolbar input[type="text"]::placeholder { color: #666; }
        .toolbar select {
            padding: 10px 14px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.3);
            color: #e0e0e0; font-size: 0.9rem; outline: none; cursor: pointer;
        }
        .btn-primary {
            padding: 10px 20px; border-radius: 10px; border: none;
            background: #7c4dff; color: #fff; font-size: 0.9rem; font-weight: 500;
            cursor: pointer; transition: all 0.2s; text-decoration: none; display: inline-block;
        }
        .btn-primary:hover { background: #651fff; }

        /* ===== Post List ===== */
        .post-list { display: flex; flex-direction: column; gap: 8px; }

        .post-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .post-item:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(124, 77, 255, 0.25);
        }
        .post-item.pinned {
            border-color: rgba(255, 152, 0, 0.3);
            background: rgba(255, 152, 0, 0.03);
        }
        .post-item-top {
            display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
        }
        .category-badge {
            display: inline-block; padding: 2px 10px; border-radius: 10px;
            font-size: 0.78rem; font-weight: 500;
        }
        .post-title {
            font-size: 1rem; font-weight: 500; color: #e0e0e0; flex: 1;
        }
        .pin-icon { color: #ff9800; font-size: 0.85rem; }
        .post-item-bottom {
            display: flex; align-items: center; gap: 12px; font-size: 0.82rem; color: #888;
        }
        .post-author { display: flex; align-items: center; gap: 5px; }
        .post-author img {
            width: 20px; height: 20px; border-radius: 50%; object-fit: cover;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .post-stat { display: flex; align-items: center; gap: 3px; }

        /* ===== Empty State ===== */
        .empty-state {
            text-align: center; padding: 60px 20px; color: #666;
        }
        .empty-state .empty-icon { font-size: 3rem; margin-bottom: 12px; }

        /* ===== Pagination ===== */
        .pagination {
            display: flex; justify-content: center; gap: 6px;
            margin-top: 20px; flex-wrap: wrap;
        }
        .page-btn {
            padding: 8px 14px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.2); color: #aaa; cursor: pointer;
            font-size: 0.85rem; transition: all 0.2s;
        }
        .page-btn:hover { background: rgba(124, 77, 255, 0.15); color: #7c4dff; }
        .page-btn.active { background: #7c4dff; color: #fff; border-color: #7c4dff; }
        .page-btn:disabled { opacity: 0.3; cursor: default; }

        /* ===== Post Detail ===== */
        .btn-back {
            background: none; border: none; color: #7c4dff; cursor: pointer;
            font-size: 0.95rem; padding: 8px 0; margin-bottom: 16px;
            display: inline-flex; align-items: center; gap: 4px;
        }
        .btn-back:hover { text-decoration: underline; }
        .post-detail-card {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
        }
        .detail-header { margin-bottom: 20px; }
        .detail-category-badge { margin-bottom: 10px; }
        .detail-title { font-size: 1.5rem; font-weight: 600; color: #e0e0e0; margin-bottom: 12px; }
        .detail-meta {
            display: flex; align-items: center; gap: 15px; font-size: 0.85rem; color: #888;
            flex-wrap: wrap; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .detail-meta .author-info { display: flex; align-items: center; gap: 6px; }
        .detail-meta .author-info img {
            width: 24px; height: 24px; border-radius: 50%; object-fit: cover;
        }
        .detail-content {
            line-height: 1.8; margin: 20px 0; color: #d0d0d0;
            word-break: break-word;
        }
        .detail-content p { margin-bottom: 12px; }
        .detail-content h1, .detail-content h2, .detail-content h3 { color: #e0e0e0; margin: 20px 0 10px; }
        .detail-content code {
            background: rgba(0,0,0,0.4); padding: 2px 6px; border-radius: 4px; font-size: 0.9em;
        }
        .detail-content pre {
            background: rgba(0,0,0,0.4); padding: 16px; border-radius: 8px;
            overflow-x: auto; margin: 12px 0;
        }
        .detail-content pre code { background: none; padding: 0; }
        .detail-content a { color: #7c4dff; }
        .detail-content table {
            width: 100%; border-collapse: collapse; margin: 12px 0;
        }
        .detail-content th, .detail-content td {
            border: 1px solid rgba(255,255,255,0.1); padding: 8px 12px; text-align: left;
        }
        .detail-content th { background: rgba(255,255,255,0.05); }
        .detail-content img { max-width: 100%; border-radius: 8px; margin: 8px 0; }

        /* ===== Attachments ===== */
        .attachments { margin-top: 16px; }
        .attachment-item {
            display: inline-flex; align-items: center; gap: 6px;
            background: rgba(0,0,0,0.3); padding: 6px 14px; border-radius: 8px;
            font-size: 0.85rem; color: #aaa; text-decoration: none;
            margin: 4px 4px 4px 0; transition: all 0.2s;
        }
        .attachment-item:hover { background: rgba(124, 77, 255, 0.15); color: #7c4dff; }

        /* ===== Action Bar (Like, Edit, Delete) ===== */
        .action-bar {
            display: flex; align-items: center; gap: 12px;
            margin-top: 20px; padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.08);
        }
        .btn-like {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 18px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.2);
            color: #aaa; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;
        }
        .btn-like:hover { border-color: #ff4081; color: #ff4081; }
        .btn-like.liked { background: rgba(255, 64, 129, 0.15); border-color: #ff4081; color: #ff4081; }
        .btn-action {
            padding: 8px 16px; border-radius: 8px; border: none;
            background: rgba(255,255,255,0.08); color: #aaa;
            cursor: pointer; font-size: 0.85rem; transition: all 0.2s;
        }
        .btn-action:hover { background: rgba(255,255,255,0.15); color: #e0e0e0; }
        .btn-action.danger:hover { background: rgba(255, 82, 82, 0.15); color: #ff5252; }
        .action-spacer { flex: 1; }

        /* ===== Comments ===== */
        .comment-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 24px;
        }
        .comment-section h3 { font-size: 1.1rem; color: #e0e0e0; margin-bottom: 16px; }
        .comment-form {
            display: flex; gap: 10px; margin-bottom: 24px;
        }
        .comment-form textarea {
            flex: 1; padding: 12px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.3);
            color: #e0e0e0; font-size: 0.9rem; resize: vertical; min-height: 60px;
            outline: none; font-family: inherit;
        }
        .comment-form textarea:focus { border-color: #7c4dff; }
        .comment-form textarea::placeholder { color: #666; }
        .comment-form button {
            padding: 12px 20px; border-radius: 10px; border: none;
            background: #7c4dff; color: #fff; cursor: pointer; font-size: 0.9rem;
            align-self: flex-end; white-space: nowrap;
        }
        .comment-form button:hover { background: #651fff; }
        .comment-list { display: flex; flex-direction: column; gap: 0; }
        .comment-item {
            padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .comment-item:last-child { border-bottom: none; }
        .comment-item.reply { margin-left: 32px; }
        .comment-header {
            display: flex; align-items: center; gap: 8px; margin-bottom: 6px;
            font-size: 0.85rem;
        }
        .comment-header img {
            width: 22px; height: 22px; border-radius: 50%; object-fit: cover;
        }
        .comment-author { color: #e0e0e0; font-weight: 500; }
        .comment-date { color: #666; }
        .comment-body { color: #ccc; font-size: 0.92rem; line-height: 1.6; margin-bottom: 6px; }
        .comment-actions { display: flex; gap: 10px; }
        .comment-actions button {
            background: none; border: none; color: #666; cursor: pointer;
            font-size: 0.8rem; padding: 2px 4px;
        }
        .comment-actions button:hover { color: #7c4dff; }
        .reply-form {
            display: flex; gap: 8px; margin-top: 8px; margin-left: 0;
        }
        .reply-form textarea {
            flex: 1; padding: 8px 12px; border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.25);
            color: #e0e0e0; font-size: 0.85rem; resize: none; height: 40px;
            outline: none; font-family: inherit;
        }
        .reply-form textarea:focus { border-color: #7c4dff; }
        .reply-form button {
            padding: 8px 14px; border-radius: 8px; border: none;
            background: #7c4dff; color: #fff; cursor: pointer; font-size: 0.83rem;
        }

        /* ===== Modal ===== */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; padding: 20px;
        }
        .modal-content {
            background: #1e2a3a; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; width: 100%; max-width: 680px;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 20px 24px; border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .modal-header h2 { font-size: 1.2rem; color: #e0e0e0; }
        .modal-close {
            background: none; border: none; color: #888; cursor: pointer;
            font-size: 1.5rem; line-height: 1; padding: 4px;
        }
        .modal-close:hover { color: #e0e0e0; }
        .modal-body { padding: 24px; display: flex; flex-direction: column; gap: 16px; }
        .modal-body label { color: #aaa; font-size: 0.85rem; margin-bottom: 4px; display: block; }
        .modal-body select,
        .modal-body input[type="text"] {
            width: 100%; padding: 10px 14px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.3);
            color: #e0e0e0; font-size: 0.95rem; outline: none;
        }
        .modal-body select:focus,
        .modal-body input[type="text"]:focus { border-color: #7c4dff; }
        .modal-body textarea {
            width: 100%; padding: 14px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.3);
            color: #e0e0e0; font-size: 0.95rem; outline: none;
            font-family: inherit; resize: vertical; min-height: 200px;
        }
        .modal-body textarea:focus { border-color: #7c4dff; }
        .modal-body textarea::placeholder { color: #555; }
        .file-upload-area {
            border: 2px dashed rgba(255,255,255,0.15); border-radius: 10px;
            padding: 20px; text-align: center; color: #666; cursor: pointer;
            transition: all 0.2s;
        }
        .file-upload-area:hover { border-color: rgba(124, 77, 255, 0.4); color: #aaa; }
        .file-upload-area input { display: none; }
        .file-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .file-tag {
            display: inline-flex; align-items: center; gap: 4px;
            background: rgba(124, 77, 255, 0.15); color: #7c4dff;
            padding: 4px 10px; border-radius: 6px; font-size: 0.82rem;
        }
        .file-tag button {
            background: none; border: none; color: #ff5252; cursor: pointer;
            font-size: 0.9rem; padding: 0 2px;
        }
        .modal-footer {
            display: flex; justify-content: flex-end; gap: 10px;
            padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.08);
        }
        .btn-cancel {
            padding: 10px 20px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.15); background: transparent;
            color: #aaa; cursor: pointer; font-size: 0.9rem;
        }
        .btn-cancel:hover { background: rgba(255,255,255,0.05); }

        /* ===== Loading ===== */
        .loading {
            display: flex; align-items: center; justify-content: center; padding: 40px;
            color: #888;
        }
        .spinner {
            width: 24px; height: 24px; border: 3px solid rgba(124, 77, 255, 0.2);
            border-top-color: #7c4dff; border-radius: 50%;
            animation: spin 0.6s linear infinite; margin-right: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ===== Toast ===== */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #333; color: #e0e0e0; padding: 12px 24px; border-radius: 10px;
            font-size: 0.9rem; z-index: 2000; opacity: 0; transition: opacity 0.3s;
            pointer-events: none;
        }
        .toast.show { opacity: 1; }

        /* ===== Responsive ===== */
        @media (max-width: 768px) {
            .container { padding: 12px; }
            .page-header h1 { font-size: 1.5rem; }
            .toolbar { flex-direction: column; }
            .toolbar input[type="text"] { min-width: unset; }
            .post-detail-card { padding: 20px; }
            .comment-item.reply { margin-left: 16px; }
            .modal-content { max-width: 100%; }
            .top-nav .nav-inner {
                flex-direction: column;
                gap: 10px;
            }
            .top-nav .nav-links {
                gap: 8px;
                justify-content: center;
            }
            .top-nav a {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- ===== Top Navigation ===== -->
    <nav class="top-nav">
        <div class="nav-inner">
            <a href="/" class="home-link">ğŸ  í™ˆ</a>
            <div class="nav-links">
                <a href="/semiconductor">ğŸ”¬ ë°˜ë„ì²´</a>
                <a href="/laborlaw">âš–ï¸ ë…¸ë™ë²•</a>
                <a href="/field-training">ğŸ­ í˜„ì¥ì‹¤ìŠµ</a>
                <a href="/safeguide">ğŸ›¡ï¸ ì•ˆì „ë³´ê±´</a>
                <a href="/msds">ğŸ§ª MSDS</a>
                <a href="/community">ğŸ’¬ ì»¤ë®¤ë‹ˆí‹°</a>
                {% if current_user.is_authenticated %}
                <div class="user-section">
                    {% if current_user.profile_image %}
                    <img src="{{ current_user.profile_image }}" alt="{{ current_user.name }}ë‹˜ì˜ í”„ë¡œí•„ ì‚¬ì§„" class="user-avatar">
                    {% endif %}
                    <span class="user-name">{{ current_user.name }}</span>
                    {% if current_user.role == 'admin' %}
                    <a href="/admin" class="admin-link">ê´€ë¦¬ì</a>
                    {% endif %}
                    <a href="/mypage">ë§ˆì´í˜ì´ì§€</a>
                    <form action="/logout" method="POST" style="display:inline;margin:0;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn-logout">ë¡œê·¸ì•„ì›ƒ</button>
                    </form>
                </div>
                {% else %}
                <a href="/login" class="btn-login-sm">ë¡œê·¸ì¸</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- ===== Page Header ===== -->
        <div class="page-header">
            <h1>ì»¤ë®¤ë‹ˆí‹°</h1>
            <p>ì§ˆë¬¸, ì •ë³´ê³µìœ , ììœ ë¡œìš´ ì†Œí†µ ê³µê°„</p>
        </div>

        <div class="main-panel">
            <!-- ===== VIEW 1: POST LIST ===== -->
            <div id="listView">
                <div class="category-tabs" id="categoryTabs">
                    <button class="tab-btn active" data-category="" onclick="setCategory('')">ì „ì²´</button>
                </div>

                <div class="toolbar">
                    <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." />
                    <select id="sortSelect" onchange="setSort(this.value)">
                        <option value="latest">ìµœì‹ ìˆœ</option>
                        <option value="popular">ì¸ê¸°ìˆœ</option>
                        <option value="views">ì¡°íšŒìˆœ</option>
                    </select>
                    {% if current_user.is_authenticated %}
                    <button class="btn-primary" onclick="openWriteModal()">ê¸€ì“°ê¸°</button>
                    {% else %}
                    <a href="/login" class="btn-primary">ë¡œê·¸ì¸ í›„ ê¸€ì“°ê¸°</a>
                    {% endif %}
                </div>

                <div id="postList" class="post-list">
                    <div class="loading"><div class="spinner"></div>ë¡œë”© ì¤‘...</div>
                </div>

                <div id="pagination" class="pagination"></div>
            </div>

            <!-- ===== VIEW 2: POST DETAIL ===== -->
            <div id="detailView" style="display:none;">
                <button class="btn-back" onclick="showListView()">â† ëª©ë¡ìœ¼ë¡œ</button>
                <div id="postDetail" class="post-detail-card"></div>
                <div id="commentSection" class="comment-section"></div>
            </div>
        </div>
    </div>

    <!-- ===== MODAL: Write / Edit Post ===== -->
    <div id="writeModal" class="modal" style="display:none;" onclick="if(event.target===this)closeWriteModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ìƒˆ ê¸€ ì‘ì„±</h2>
                <button class="modal-close" onclick="closeWriteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div>
                    <label for="formCategory">ì¹´í…Œê³ ë¦¬</label>
                    <select id="formCategory"></select>
                </div>
                <div>
                    <label for="formTitle">ì œëª©</label>
                    <input type="text" id="formTitle" maxlength="200" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
                </div>
                <div>
                    <label for="formContent">ë‚´ìš©</label>
                    <textarea id="formContent" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”... (ë§ˆí¬ë‹¤ìš´ ì§€ì›)"></textarea>
                </div>
                <div>
                    <label>ì²¨ë¶€íŒŒì¼</label>
                    <div class="file-upload-area" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" multiple
                               accept=".png,.jpg,.jpeg,.gif,.webp,.pdf,.docx,.xlsx,.hwp" />
                        í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ (ìµœëŒ€ 10MB)
                    </div>
                    <div class="file-list" id="fileList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeWriteModal()">ì·¨ì†Œ</button>
                <button class="btn-primary" onclick="submitPost()">ë“±ë¡</button>
            </div>
        </div>
    </div>

    <!-- ===== Toast ===== -->
    <div class="toast" id="toast"></div>

    <script>
    // ===== State =====
    const API = '/api/v1/community';
    const isAuthenticated = {{ 'true' if current_user.is_authenticated else 'false' }};
    const currentUserId = {{ current_user.id if current_user.is_authenticated else 'null' }};
    const currentUserRole = '{{ current_user.role if current_user.is_authenticated else "" }}';

    let categories = [];
    let currentPage = 1;
    let currentCategory = '';
    let currentSort = 'latest';
    let searchTimeout = null;
    let editingPostId = null;
    let selectedFiles = [];
    let _currentPostData = null;  // post detail cache (avoids large dataset attrs)

    // ===== Helpers =====
    function escapeHtml(text) {
        const d = document.createElement('div');
        d.textContent = text;
        return d.innerHTML;
    }

    function formatDate(iso) {
        if (!iso) return '';
        const d = new Date(iso + (iso.endsWith('Z') ? '' : 'Z'));
        const now = new Date();
        const diff = (now - d) / 1000;
        if (diff < 60) return 'ë°©ê¸ˆ ì „';
        if (diff < 3600) return Math.floor(diff / 60) + 'ë¶„ ì „';
        if (diff < 86400) return Math.floor(diff / 3600) + 'ì‹œê°„ ì „';
        if (diff < 604800) return Math.floor(diff / 86400) + 'ì¼ ì „';
        return d.toLocaleDateString('ko-KR');
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / 1048576).toFixed(1) + ' MB';
    }

    function showToast(msg) {
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 2500);
    }

    function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1,3), 16);
        const g = parseInt(hex.slice(3,5), 16);
        const b = parseInt(hex.slice(5,7), 16);
        return `rgba(${r},${g},${b},${alpha})`;
    }

    const CSRF_TOKEN = '{{ csrf_token() }}';

    async function apiFetch(url, options = {}) {
        try {
            if (options.method && options.method.toUpperCase() !== 'GET') {
                options.headers = { ...options.headers, 'X-CSRFToken': CSRF_TOKEN };
            }
            const resp = await fetch(url, options);
            const data = await resp.json();
            if (!resp.ok || !data.success) {
                showToast(data.error || data.message || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                return null;
            }
            return data;
        } catch (e) {
            showToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            return null;
        }
    }

    // ===== Markdown Rendering =====
    function renderMarkdown(text) {
        if (typeof marked !== 'undefined') {
            const html = marked.parse(text || '');
            if (typeof DOMPurify !== 'undefined') {
                return DOMPurify.sanitize(html, { ADD_ATTR: ['target'] });
            }
            console.warn('DOMPurify not loaded, falling back to escaped text');
        }
        return escapeHtml(text || '').replace(/\n/g, '<br>');
    }

    // ===== View Management =====
    function showListView() {
        document.getElementById('listView').style.display = '';
        document.getElementById('detailView').style.display = 'none';
        window.location.hash = '';
        loadPosts();
    }

    function showDetailView(postId) {
        document.getElementById('listView').style.display = 'none';
        document.getElementById('detailView').style.display = '';
        window.location.hash = `post/${postId}`;
        loadPostDetail(postId);
    }

    // ===== Categories =====
    async function loadCategories() {
        const data = await apiFetch(`${API}/categories`);
        if (!data) return;
        categories = data.data;

        const tabs = document.getElementById('categoryTabs');
        let html = '<button class="tab-btn active" data-category="" onclick="setCategory(\'\')">ì „ì²´</button>';
        categories.forEach(c => {
            html += `<button class="tab-btn" data-category="${c.slug}" onclick="setCategory('${c.slug}')">${c.icon || ''} ${escapeHtml(c.name)}</button>`;
        });
        tabs.innerHTML = html;

        // Populate form select
        const sel = document.getElementById('formCategory');
        sel.innerHTML = categories
            .filter(c => c.slug !== 'notice' || currentUserRole === 'admin')
            .map(c => `<option value="${c.id}">${c.icon || ''} ${escapeHtml(c.name)}</option>`)
            .join('');
    }

    function setCategory(slug) {
        currentCategory = slug;
        currentPage = 1;
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.category === slug);
        });
        loadPosts();
    }

    function setSort(val) {
        currentSort = val;
        currentPage = 1;
        loadPosts();
    }

    // ===== Post List =====
    async function loadPosts() {
        const list = document.getElementById('postList');
        list.innerHTML = '<div class="loading"><div class="spinner"></div>ë¡œë”© ì¤‘...</div>';

        const search = document.getElementById('searchInput').value.trim();
        const params = new URLSearchParams({
            page: currentPage, per_page: 20,
            sort: currentSort,
        });
        if (currentCategory) params.set('category', currentCategory);
        if (search) params.set('search', search);

        const data = await apiFetch(`${API}/posts?${params}`);
        if (!data) { list.innerHTML = '<div class="empty-state">ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>'; return; }

        const { posts, total, pages, current_page } = data.data;

        if (!posts.length) {
            list.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“</div>ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.${isAuthenticated ? '<br>ì²« ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!' : ''}</div>`;
            document.getElementById('pagination').innerHTML = '';
            return;
        }

        list.innerHTML = posts.map(p => {
            const cat = p.category || {};
            const badgeStyle = cat.color
                ? `background:${hexToRgba(cat.color, 0.15)};color:${cat.color};`
                : 'background:rgba(255,255,255,0.1);color:#aaa;';
            const author = p.author || {};
            const avatar = author.profile_image
                ? `<img src="${escapeHtml(author.profile_image)}" alt="" />`
                : '';
            return `
                <div class="post-item ${p.is_pinned ? 'pinned' : ''}" onclick="showDetailView(${p.id})">
                    <div class="post-item-top">
                        <span class="category-badge" style="${badgeStyle}">${escapeHtml((cat.icon||'') + ' ' + (cat.name||''))}</span>
                        <span class="post-title">${escapeHtml(p.title)}</span>
                        ${p.is_pinned ? '<span class="pin-icon">ğŸ“Œ</span>' : ''}
                    </div>
                    <div class="post-item-bottom">
                        <span class="post-author">${avatar} ${escapeHtml(author.name || 'ìµëª…')}</span>
                        <span>${formatDate(p.created_at)}</span>
                        <span class="post-stat">ğŸ‘ ${p.view_count}</span>
                        <span class="post-stat">â¤ï¸ ${p.like_count}</span>
                        <span class="post-stat">ğŸ’¬ ${p.comment_count}</span>
                    </div>
                </div>`;
        }).join('');

        renderPagination(total, pages, current_page);
    }

    function renderPagination(total, pages, current) {
        const el = document.getElementById('pagination');
        if (pages <= 1) { el.innerHTML = ''; return; }

        let html = '';
        html += `<button class="page-btn" onclick="goPage(${current-1})" ${current<=1?'disabled':''}>â€¹</button>`;

        let start = Math.max(1, current - 2);
        let end = Math.min(pages, start + 4);
        start = Math.max(1, end - 4);

        for (let i = start; i <= end; i++) {
            html += `<button class="page-btn ${i===current?'active':''}" onclick="goPage(${i})">${i}</button>`;
        }
        html += `<button class="page-btn" onclick="goPage(${current+1})" ${current>=pages?'disabled':''}>â€º</button>`;
        el.innerHTML = html;
    }

    function goPage(p) {
        currentPage = p;
        loadPosts();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ===== Post Detail =====
    async function loadPostDetail(postId) {
        const detail = document.getElementById('postDetail');
        detail.innerHTML = '<div class="loading"><div class="spinner"></div>ë¡œë”© ì¤‘...</div>';

        const data = await apiFetch(`${API}/posts/${postId}`);
        if (!data) { detail.innerHTML = '<div class="empty-state">ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

        const p = data.data;
        const cat = p.category || {};
        const author = p.author || {};
        const badgeStyle = cat.color
            ? `background:${hexToRgba(cat.color, 0.15)};color:${cat.color};`
            : '';
        const avatar = author.profile_image
            ? `<img src="${escapeHtml(author.profile_image)}" alt="" />`
            : '';

        const isOwner = currentUserId === (author.id || null);
        const isAdmin = currentUserRole === 'admin';

        let attachHtml = '';
        if (p.attachments && p.attachments.length) {
            attachHtml = '<div class="attachments">' +
                p.attachments.map(a =>
                    `<a class="attachment-item" href="${escapeHtml(a.url)}" target="_blank">ğŸ“ ${escapeHtml(a.original_filename)} (${formatFileSize(a.file_size)})</a>`
                ).join('') + '</div>';
        }

        detail.innerHTML = `
            <div class="detail-header">
                <div class="detail-category-badge">
                    <span class="category-badge" style="${badgeStyle}">${escapeHtml((cat.icon||'') + ' ' + (cat.name||''))}</span>
                </div>
                <div class="detail-title">${escapeHtml(p.title)}</div>
                <div class="detail-meta">
                    <span class="author-info">${avatar} ${escapeHtml(author.name || 'ìµëª…')}</span>
                    <span>${formatDate(p.created_at)}</span>
                    <span>ì¡°íšŒ ${p.view_count}</span>
                    ${p.updated_at ? '<span>(ìˆ˜ì •ë¨)</span>' : ''}
                </div>
            </div>
            <div class="detail-content">${renderMarkdown(p.content)}</div>
            ${attachHtml}
            <div class="action-bar">
                <button class="btn-like ${p.liked_by_me ? 'liked' : ''}" onclick="toggleLike(${p.id})" data-post-id="${p.id}">
                    â¤ï¸ <span id="likeCount">${p.like_count}</span>
                </button>
                <span class="action-spacer"></span>
                ${isOwner ? `<button class="btn-action" onclick="openEditModal(${p.id})">ìˆ˜ì •</button>` : ''}
                ${isOwner || isAdmin ? `<button class="btn-action danger" onclick="deletePost(${p.id})">ì‚­ì œ</button>` : ''}
            </div>`;

        // Store post data for edit modal
        _currentPostData = p;

        renderCommentSection(p.id, p.comments || []);
    }

    // ===== Comments =====
    function renderCommentSection(postId, comments) {
        const section = document.getElementById('commentSection');
        const commentCount = countComments(comments);

        let formHtml = '';
        if (isAuthenticated) {
            formHtml = `
                <div class="comment-form">
                    <textarea id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    <button onclick="submitComment(${postId})">ë“±ë¡</button>
                </div>`;
        } else {
            formHtml = '<p style="color:#666;margin-bottom:16px;font-size:0.9rem;"><a href="/login" style="color:#7c4dff;">ë¡œê·¸ì¸</a> í›„ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>';
        }

        section.innerHTML = `
            <h3>ğŸ’¬ ëŒ“ê¸€ ${commentCount}ê°œ</h3>
            ${formHtml}
            <div class="comment-list" id="commentList">
                ${renderComments(comments, postId)}
            </div>`;
    }

    function countComments(comments) {
        let c = 0;
        comments.forEach(cm => { c++; if (cm.replies) c += countComments(cm.replies); });
        return c;
    }

    function renderComments(comments, postId) {
        if (!comments.length) return '<p style="color:#555;font-size:0.9rem;text-align:center;padding:16px;">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return comments.map(c => renderCommentItem(c, postId, false)).join('');
    }

    function renderCommentItem(c, postId, isReply) {
        const author = c.author || {};
        const avatar = author.profile_image
            ? `<img src="${escapeHtml(author.profile_image)}" alt="" />`
            : '';
        const isOwner = currentUserId === (author.id || null);
        const isAdmin = currentUserRole === 'admin';

        let repliesHtml = '';
        if (c.replies && c.replies.length) {
            repliesHtml = c.replies.map(r => renderCommentItem(r, postId, true)).join('');
        }

        return `
            <div class="comment-item ${isReply ? 'reply' : ''}">
                <div class="comment-header">
                    ${avatar}
                    <span class="comment-author">${escapeHtml(author.name || 'ìµëª…')}</span>
                    <span class="comment-date">${formatDate(c.created_at)}</span>
                </div>
                <div class="comment-body">${c.is_deleted ? '<em style="color:#666;">ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤.</em>' : escapeHtml(c.content)}</div>
                ${!c.is_deleted ? `
                <div class="comment-actions">
                    ${isAuthenticated && !isReply ? `<button onclick="showReplyForm(${c.id}, ${postId})">ë‹µê¸€</button>` : ''}
                    ${isOwner || isAdmin ? `<button onclick="deleteComment(${c.id}, ${postId})">ì‚­ì œ</button>` : ''}
                </div>
                <div id="replyForm-${c.id}"></div>` : ''}
            </div>
            ${repliesHtml}`;
    }

    function showReplyForm(commentId, postId) {
        const container = document.getElementById(`replyForm-${commentId}`);
        if (container.innerHTML) { container.innerHTML = ''; return; }
        container.innerHTML = `
            <div class="reply-form">
                <textarea id="replyInput-${commentId}" placeholder="ë‹µê¸€ ì…ë ¥..."></textarea>
                <button onclick="submitReply(${postId}, ${commentId})">ë“±ë¡</button>
            </div>`;
        document.getElementById(`replyInput-${commentId}`).focus();
    }

    async function submitComment(postId) {
        const input = document.getElementById('commentInput');
        const content = input.value.trim();
        if (!content) { showToast('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

        const data = await apiFetch(`${API}/posts/${postId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content }),
        });
        if (data) {
            showToast('ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadPostDetail(postId);
        }
    }

    async function submitReply(postId, parentId) {
        const input = document.getElementById(`replyInput-${parentId}`);
        const content = input.value.trim();
        if (!content) { showToast('ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

        const data = await apiFetch(`${API}/posts/${postId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content, parent_id: parentId }),
        });
        if (data) {
            showToast('ë‹µê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadPostDetail(postId);
        }
    }

    async function deleteComment(commentId, postId) {
        if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const data = await apiFetch(`${API}/comments/${commentId}`, { method: 'DELETE' });
        if (data) {
            showToast('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadPostDetail(postId);
        }
    }

    // ===== Likes =====
    async function toggleLike(postId) {
        if (!isAuthenticated) { showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }

        const data = await apiFetch(`${API}/posts/${postId}/like`, { method: 'POST' });
        if (!data) return;

        const btn = document.querySelector(`.btn-like[data-post-id="${postId}"]`);
        if (btn) {
            btn.classList.toggle('liked', data.data.liked);
            document.getElementById('likeCount').textContent = data.data.like_count;
        }
    }

    // ===== Write / Edit Modal =====
    function openWriteModal() {
        editingPostId = null;
        selectedFiles = [];
        document.getElementById('modalTitle').textContent = 'ìƒˆ ê¸€ ì‘ì„±';
        document.getElementById('formTitle').value = '';
        document.getElementById('formContent').value = '';
        document.getElementById('fileList').innerHTML = '';
        document.getElementById('fileInput').value = '';
        if (categories.length) {
            document.getElementById('formCategory').selectedIndex = 0;
        }
        document.getElementById('writeModal').style.display = '';
        document.getElementById('formTitle').focus();
    }

    function openEditModal(postId) {
        const p = _currentPostData || {};
        editingPostId = postId;
        selectedFiles = [];
        document.getElementById('modalTitle').textContent = 'ê¸€ ìˆ˜ì •';
        document.getElementById('formTitle').value = p.title || '';
        document.getElementById('formContent').value = p.content || '';
        document.getElementById('fileList').innerHTML = '';
        document.getElementById('fileInput').value = '';
        if (p.category) {
            const sel = document.getElementById('formCategory');
            for (let i = 0; i < sel.options.length; i++) {
                if (parseInt(sel.options[i].value) === p.category.id) {
                    sel.selectedIndex = i; break;
                }
            }
        }
        document.getElementById('writeModal').style.display = '';
    }

    function closeWriteModal() {
        document.getElementById('writeModal').style.display = 'none';
    }

    async function submitPost() {
        const title = document.getElementById('formTitle').value.trim();
        const content = document.getElementById('formContent').value.trim();
        const categoryId = parseInt(document.getElementById('formCategory').value);

        if (!title || title.length < 2) { showToast('ì œëª©ì€ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'); return; }
        if (!content) { showToast('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

        const body = { title, content, category_id: categoryId };

        let data;
        if (editingPostId) {
            data = await apiFetch(`${API}/posts/${editingPostId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
        } else {
            data = await apiFetch(`${API}/posts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
        }

        if (!data) return;

        const postId = data.data.id;

        // Upload files if any
        if (selectedFiles.length > 0) {
            for (const file of selectedFiles) {
                const formData = new FormData();
                formData.append('file', file);
                await apiFetch(`${API}/posts/${postId}/attachments`, {
                    method: 'POST',
                    body: formData,
                });
            }
        }

        closeWriteModal();
        showToast(editingPostId ? 'ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ê²Œì‹œê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');

        if (editingPostId) {
            loadPostDetail(postId);
        } else {
            showDetailView(postId);
        }
    }

    // ===== Delete Post =====
    async function deletePost(postId) {
        if (!confirm('ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const data = await apiFetch(`${API}/posts/${postId}`, { method: 'DELETE' });
        if (data) {
            showToast('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            showListView();
        }
    }

    // ===== File Handling =====
    document.getElementById('fileInput').addEventListener('change', function() {
        const newFiles = Array.from(this.files);
        newFiles.forEach(f => {
            if (f.size > 10 * 1024 * 1024) {
                showToast(`${f.name}: 10MB ì´í•˜ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
            } else {
                selectedFiles.push(f);
            }
        });
        renderFileList();
        this.value = '';
    });

    function renderFileList() {
        const el = document.getElementById('fileList');
        el.innerHTML = selectedFiles.map((f, i) =>
            `<span class="file-tag">${escapeHtml(f.name)} (${formatFileSize(f.size)}) <button onclick="removeFile(${i})">&times;</button></span>`
        ).join('');
    }

    function removeFile(idx) {
        selectedFiles.splice(idx, 1);
        renderFileList();
    }

    // ===== Search =====
    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => { currentPage = 1; loadPosts(); }, 400);
    });

    document.getElementById('searchInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { clearTimeout(searchTimeout); currentPage = 1; loadPosts(); }
    });

    // ===== URL Hash Routing =====
    function handleHashChange() {
        const hash = window.location.hash.slice(1);
        if (hash.startsWith('post/')) {
            const postId = parseInt(hash.split('/')[1]);
            if (postId) { showDetailView(postId); return; }
        }
        document.getElementById('listView').style.display = '';
        document.getElementById('detailView').style.display = 'none';
    }

    window.addEventListener('hashchange', handleHashChange);

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', async () => {
        await loadCategories();
        const hash = window.location.hash.slice(1);
        if (hash.startsWith('post/')) {
            const postId = parseInt(hash.split('/')[1]);
            if (postId) { showDetailView(postId); return; }
        }
        loadPosts();
    });
    </script>

</body>
</html>
